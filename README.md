ТЕХНИЧЕСКОЕ ЗАДАНИЕ
Интеграция системы Ident с CRM Битрикс24
________________________________________
1. ОБЩИЕ СВЕДЕНИЯ
1.1. Полное наименование системы
Наименование: Система интеграции стоматологической информационной системы Ident с облачной CRM Битрикс24
Краткое наименование: Интеграция Ident-Битрикс24
1.2. Основание для разработки
Основание: Необходимость централизованного управления данными о пациентах и записях из пяти филиалов организации в единой CRM-системе для повышения эффективности работы кураторов лечения.
Инициатор проекта: GitPro
1.3. Цель и назначение разработки
Цель разработки:
Создание автоматизированной системы синхронизации данных о записях пациентов и планах лечения из локальных баз данных Ident в единую облачную CRM Битрикс24 для обеспечения централизованного контроля и управления бизнес-процессами.
Назначение системы:
1.	Автоматическая передача данных о записях пациентов из Ident в Битрикс24
2.	Централизация информации из пяти филиалов в одной системе
3.	Обеспечение кураторов лечения актуальными данными о пациентах
4.	Отслеживание статусов записей и планов лечения в режиме, близком к реальному времени
5.	Снижение ручного труда по переносу данных между системами
1.4. Сроки выполнения работ
Общий срок реализации: 55 рабочих дней с момента утверждения ТЗ
Этапы реализации:
Этап	Срок	Длительность
Этап 1: Разработка и тестирование	30 рабочих дней	3 недели
Этап 2: Пилотное внедрение	10 рабочих дней	2 недели
Этап 3: Промышленная эксплуатация	15 рабочих дней	2 недели
________________________________________
2. ОПИСАНИЕ РАЗРАБАТЫВАЕМОГО РЕШЕНИЯ
2.1. Общая архитектура решения
Компонентная структура:
1.	Интеграционный модуль - программное обеспечение, устанавливаемое на сервисных ПК в каждом филиале
2.	Модуль извлечения данных - компонент для чтения данных из БД Ident
3.	Модуль преобразования данных - компонент для маппинга и валидации данных
4.	Модуль отправки данных - компонент для передачи данных в Битрикс24 через webhook
5.	Модуль логирования - компонент для ведения журналов работы
6.	Модуль управления очередью - компонент для обработки неотправленных данных
7.	Локальное приложение в Битрикс24 - веб-приложение для отображения планов лечения
Топология размещения:
•	Интеграционные модули: 5 независимых экземпляров на сервисных ПК (по одному в каждом филиале)
•	БД Ident: 4 сервера SQL Server (Филиал 1 и 2 на одной БД, Филиалы 3, 4, 5 - отдельные БД)
•	Битрикс24: Облачный сервис (единая точка интеграции для всех филиалов)
•	Сетевое взаимодействие: Исходящие HTTPS-соединения от каждого филиала к Битрикс24
2.2. Технологический стек
Интеграционный модуль:
•	Язык разработки: Python 3.10+
•	Библиотеки: pyodbc (работа с SQL Server), requests (HTTP-запросы), schedule (планировщик)
•	Упаковка: PyInstaller (создание исполняемого файла)
•	Развертывание: Windows Service
База данных Ident:
•	СУБД: Microsoft SQL Server (версия до 2016)
•	Метод доступа: ODBC-соединение
•	Режим работы: Только чтение (read-only)
Битрикс24:
•	API: REST API
•	Метод авторизации: Входящий webhook
•	Протокол: HTTPS
Локальное приложение:
•	Технология: HTML5, JavaScript, CSS3
•	Фреймворк: Нативный JavaScript (ES6+)
•	API Битрикс24: BX24.js SDK
•	Размещение: Iframe в карточке сделки
2.3. Синхронизируемые сущности
2.3.1. Запись на приём (Receptions → Deal)
Направление: Ident → Битрикс24 (Сделка)
Состав данных: 17 полей (детализация в документе "Схемы маппинга данных")
Основные поля:
•	Идентификационные данные пациента (ФИО, телефон, номер карты)
•	Данные записи (дата/время начала и окончания, филиал, кабинет)
•	Данные врача (ФИО, специальность)
•	Услуги и финансы (перечень услуг, сумма)
•	Статусы и метки времени (создание, приход, начало, завершение, отмена)
•	Дополнительная информация (комментарий, причина отмены, источник записи)
Периодичность синхронизации: Каждые 2 минуты
Объем данных: 10-50 записей за цикл синхронизации (один филиал)
2.3.2. План лечения (TreatmentPlans → Local App)
Направление: Ident → Локальное приложение Битрикс24
Состав данных: 12 полей (детализация в документе "Схемы маппинга данных")
Основные поля:
•	Информация о плане (ID, название, дата создания)
•	Пациент и врач (ФИО)
•	Структура плана (этапы, элементы, услуги)
•	Финансы (цена, скидка, итого)
•	Статус выполнения
Периодичность синхронизации: По запросу из локального приложения (on-demand)
Объем данных: 1 план за запрос
2.4. Логика работы системы
2.4.1. Процесс синхронизации записей
Шаг 1. Извлечение данных из Ident
•	Выполнение SQL-запроса к БД Ident
•	Фильтрация по времени последней синхронизации (инкрементальная выборка)
•	Определение филиала через связанные таблицы
•	Агрегация услуг по записям
Шаг 2. Преобразование данных
•	Валидация обязательных полей
•	Нормализация телефонных номеров
•	Преобразование дат в формат ISO 8601
•	Формирование уникального идентификатора (F[N]_[ID])
•	Определение стадии воронки по алгоритму приоритетов
Шаг 3. Поиск клиента в Битрикс24
•	Поиск по телефону в контактах и лидах
•	Обработка трех сценариев: 
o	Клиент не найден → создание контакта и сделки
o	Найден лид → конвертация в контакт и сделку
o	Найден контакт → поиск сделки по ID или создание новой
Шаг 4. Отправка данных в Битрикс24
•	Формирование JSON-запроса
•	Отправка через webhook API
•	Обработка ответа
•	Сохранение результата в журнал
Шаг 5. Обработка ошибок
•	При неудаче - сохранение в локальную очередь
•	Повторная попытка через установленный интервал
•	Уведомление администратора при критических ошибках
2.4.2. Процесс работы локального приложения
Шаг 1. Инициализация приложения
•	Загрузка в iframe карточки сделки
•	Получение ID текущей сделки
Шаг 2. Извлечение ФИО пациента
•	Получение данных сделки через API Битрикс24
•	Извлечение ID связанного контакта
•	Получение данных контакта (ФИО)
•	Альтернативно: извлечение ФИО из названия сделки
Шаг 3. Запрос плана лечения
•	Формирование GET-запроса к интеграционному API
•	Передача ФИО пациента в качестве параметра
•	Получение JSON-ответа с данными плана
Шаг 4. Отображение плана
•	Парсинг JSON-данных
•	Построение HTML-таблицы с этапами и услугами
•	Визуализация статусов выполнения (цветные индикаторы)
•	Расчет и отображение итоговых сумм
________________________________________
3. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ
3.1. Требования к синхронизации данных
1. Система должна автоматически синхронизировать записи из Ident в Битрикс24 с интервалом 2 минуты
2. Система должна использовать инкрементальную синхронизацию (только новые и измененные записи)
3. Система должна корректно идентифицировать филиал для каждой записи, включая случай двух филиалов на одной БД
4. Система должна создавать новые контакты для пациентов, отсутствующих в Битрикс24
5. Система должна конвертировать лиды в контакты и сделки при обнаружении записи
6. Система должна обновлять существующие сделки при изменении статуса записи
7. Система должна определять стадию воронки на основе типа услуги, статуса записи и наличия плана лечения
8. Система должна защищать ручные стадии воронки от автоматического изменения
9. Система должна предоставлять локальное приложение для просмотра планов лечения в карточке сделки
10. Локальное приложение должно находить план лечения по ФИО пациента из связанного контакта
3.2. Требования к обработке данных
1. Система должна валидировать все обязательные поля перед отправкой
2. Система должна нормализовать телефонные номера в формат +7XXXXXXXXXX
3. Система должна преобразовывать даты в формат ISO 8601 с временной зоной
4. Система должна формировать уникальный идентификатор записи формата F[N]_[ID]
5. Система должна агрегировать множественные услуги в строку через запятую
6. Система должна рассчитывать общую сумму записи с учетом скидок
7. Система должна обрезать список услуг до 3000 символов с добавлением информации об оставшихся
3.3. Требования к надежности
1. Система должна автоматически перезапускаться после критических ошибок в течение 5 минут
2. Система должна повторять неудачные запросы с экспоненциальной задержкой (30с, 1м, 5м)
3. Система должна вести детальный журнал всех операций с ротацией файлов (30 дней)
4. Система должна отправлять уведомления администратору при превышении порога ошибок (>10% за час)
3.4. Требования к производительности
1. Обработка одной записи не должна превышать 2 секунды
2. Полный цикл синхронизации 50 записей не должен превышать 2 минуты
3. Использование CPU в режиме ожидания не должно превышать 2%
4. Использование RAM не должно превышать 200 МБ
5. Время запуска интеграционного модуля не должно превышать 10 секунд
________________________________________
4. НЕФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ
4.1. Требования к надежности и доступности
1. Целевая доступность системы: 99% (допустимый простой не более 7 часов в месяц)
2. Максимальное время восстановления после сбоя: 5 минут
3. Глубина очереди неотправленных данных: до 1000 записей
4.2. Требования к безопасности
1. Все данные должны передаваться по защищенному протоколу HTTPS (TLS 1.2+)
2. Webhook-токен должен храниться в зашифрованном виде
3. Учетные данные БД должны храниться в защищенном хранилище
4. Журналы не должны содержать персональные данные в открытом виде
5. Доступ к конфигурационным файлам должен быть ограничен правами учетной записи службы
4.3. Требования к масштабируемости
1. Система должна поддерживать увеличение количества филиалов до 10 без изменения архитектуры
2. Система должна справляться с увеличением объемов данных в 2 раза без деградации производительности
3.Архитектура должна позволять добавление новых синхронизируемых сущностей
4.4. Требования к эксплуатации
1. Установка системы должна быть автоматизирована с помощью установочного скрипта
2. Время установки на одном ПК не должно превышать 10 минут
3. Система должна поддерживать обновление без потери конфигурации
4. Система должна предоставлять веб-интерфейс для мониторинга на localhost
5. Система должна автоматически выполнять ротацию журналов (файлы старше 30 дней удаляются)
________________________________________
5. КРИТЕРИИ ПРИЕМКИ
5.1. Критерии приемки функциональности
№	Критерий	Метод проверки	Ожидаемый результат
1	Создание новой записи	Создание записи в Ident, проверка в Битрикс24 через 5 минут	Сделка создана с корректными данными
2	Обновление статуса записи	Изменение статуса в Ident, проверка в Битрикс24 через 5 минут	Стадия сделки обновлена корректно
3	Конвертация лида	Создание лида, затем записи с тем же телефоном	Лид конвертирован, сделка создана
4	Определение филиала	Проверка 100 случайных записей	Филиал определен корректно в 100% случаев
5	Отображение плана лечения	Открытие сделки с планом лечения	План отображается корректно в локальном приложении
6	Защита ручных стадий	Перевод сделки в PLAN_PRESENTATION, синхронизация записи	Стадия не изменилась
7	Обработка отмены	Отмена записи в Ident	Сделка переведена в LOSE с причиной
8	Агрегация услуг	Запись с 5+ услугами	Все услуги перечислены через запятую
9	Множественные планы	Пациент с 3 планами лечения	Отображается список для выбора
10	Работа без услуг	Запись без заказа (услуги пусты)	Сделка создана с пустым полем услуг
5.2. Критерии приемки производительности
№	Критерий	Метод проверки	Ожидаемый результат
1	Время обработки записи	Замер времени обработки 100 записей	Среднее время ≤ 2 секунды
2	Время цикла синхронизации	Синхронизация пакета из 50 записей	Время ≤ 2 минуты
3	Использование CPU в покое	Мониторинг 24 часа	Среднее ≤ 2%
4	Использование RAM	Мониторинг 24 часа	Пиковое ≤ 200 МБ
5	Время запуска службы	Перезапуск службы 10 раз	Среднее ≤ 10 секунд
6	Нагрузка на БД	Мониторинг запросов 1 час	Не более 1 одновременного подключения
5.3. Критерии приемки надежности
№	Критерий	Метод проверки	Ожидаемый результат
1	Автоперезапуск после сбоя	Принудительное завершение процесса	Перезапуск в течение 5 минут
2	Работа с очередью	Отключение сети на 10 минут	Данные сохранены, отправлены после восстановления
3	Обработка ошибок API	Симуляция ошибок 429, 500	Повторные попытки с задержкой
4	Ротация журналов	Работа системы 35 дней	Файлы старше 30 дней удалены
5	Уведомления об ошибках	Генерация 15 ошибок за час	Администратор получил уведомление
5.4. Критерии приемки безопасности
№	Критерий	Метод проверки	Ожидаемый результат
1	Шифрование webhook-токена	Просмотр конфигурационного файла	Токен в зашифрованном виде
2	Защита персональных данных	Анализ журналов	ФИО и телефоны замаскированы
3	Протокол передачи	Анализ сетевого трафика	Только HTTPS, TLS 1.2+
4	Права доступа	Проверка прав на файлы	Доступ только для учетной записи службы
________________________________________
6. ПЛАН-ГРАФИК РЕАЛИЗАЦИИ
6.1. Этап 1: Разработка и тестирование (30 рабочих дней)
Цель: Создание полнофункционального интеграционного решения
№	Задача	Длительность	Ответственный	Результат
1.1	Разработка модуля извлечения данных	5 дней	GitPro	SQL-запросы для всех сущностей
1.2	Разработка модуля преобразования	5 дней	GitPro	Валидация, нормализация, маппинг
1.3	Разработка модуля отправки в API	3 дня	GitPro	Интеграция с webhook Битрикс24
1.4	Разработка модуля логирования	2 дня	GitPro	Система журналирования
1.5	Разработка модуля очередей	3 дня	GitPro	Обработка неотправленных данных
1.6	Разработка локального приложения	5 дней	GitPro	HTML/JS приложение для планов
1.7	Интеграционное тестирование	5 дней	GitPro	Протокол тестирования
1.8	Исправление ошибок	2 дня	GitPro	Обновленная версия
Контрольная точка 1 (КТ1): Завершение разработки и успешное прохождение тестирования
Критерии прохождения КТ1:
•	Все функциональные требования реализованы
•	Интеграционные тесты пройдены на 100%
•	Критичные ошибки отсутствуют
•	Документация по установке подготовлена
6.2. Этап 2: Пилотное внедрение (15 рабочих дней)
Цель: Апробация решения на одном филиале
№	Задача	Длительность	Ответственный	Результат
2.1	Подготовка пилотного филиала	1 день	GitPro	Сервисный ПК готов
2.2	Установка интеграционного модуля	1 день	GitPro	Служба установлена и запущена
2.3	Настройка webhook в Битрикс24	1 день	GitPro	Webhook создан, токен получен
2.4	Настройка локального приложения	1 день	GitPro	Приложение доступно в сделках
2.5	Начальная синхронизация данных	2 дня	GitPro	Исторические данные загружены
2.6	Обучение кураторов	1 день	GitPro	Инструкции, обучающие материалы
2.7	Пилотная эксплуатация	3 дня	GitPro	Отчет о пилотной эксплуатации
2.8	Анализ результатов и корректировки	1 день	GitPro	План доработок
Контрольная точка 2 (КТ2): Успешное завершение пилота
Критерии прохождения КТ2:
•	Синхронизация работает стабильно 5 дней подряд
•	Ошибки синхронизации < 2%
•	Кураторы положительно оценивают решение (≥ 4/5)
•	Критичные замечания отсутствуют
6.3. Этап 3: Промышленная эксплуатация (15 рабочих дней)
Цель: Развертывание на всех филиалах
№	Задача	Длительность	Ответственный	Результат
3.1	Внесение доработок по пилоту	3 дня	GitPro	Обновленная версия
3.2	Развертывание в Филиале 2	2 дня	GitPro	Филиал 2 подключен
3.3	Развертывание в Филиале 3	2 дня	GitPro	Филиал 3 подключен
3.4	Развертывание в Филиале 4	2 дня	GitPro	Филиал 4 подключен
3.5	Развертывание в Филиале 5	2 дня	GitPro	Филиал 5 подключен
3.6	Обучение всех кураторов	2 дня	GitPro	Все кураторы обучены
3.7	Мониторинг промышленной эксплуатации	5 дней	GitPro	Отчет о стабильности
3.8	Приемочные испытания	2 дня	Заказчик	Акт приемки
Контрольная точка 3 (КТ3): Приемка системы в эксплуатацию
Критерии прохождения КТ3:
•	Все 5 филиалов успешно синхронизируются
•	Критерии приемки выполнены на 100%
•	Все кураторы обучены и работают в системе
•	Акт приемки подписан Заказчиком
________________________________________
7. МЕТОДИКА ИСПЫТАНИЙ
7.1. Виды испытаний
7.1.1. Модульное тестирование
Проводится разработчиками в процессе разработки.
Объекты тестирования:
•	Модуль извлечения данных
•	Модуль преобразования данных
•	Модуль отправки данных
•	Модуль логирования
•	Модуль управления очередью
•	Локальное приложение
Метод: Unit-тесты с покрытием не менее 80%
7.1.2. Интеграционное тестирование
Проводится QA-инженером после завершения разработки.
Сценарии тестирования:
№	Сценарий	Входные данные	Ожидаемый результат
1	Создание новой записи	Запись в Ident с новым пациентом	Контакт и сделка созданы в Битрикс24
2	Обновление записи	Изменение статуса в Ident	Стадия сделки обновлена
3	Конвертация лида	Лид в Битрикс24 + запись в Ident	Лид конвертирован, сделка создана
4	Отмена записи	Отмена записи в Ident	Сделка в стадии LOSE с причиной
5	Множественные услуги	Запись с 10 услугами	Все услуги в поле UF_CRM_SERVICES
6	Определение филиала (2 на 1 БД)	Записи из Филиала 1 и 2	Филиалы определены корректно
7	План лечения - отображение	Открытие сделки с планом	План корректно отображается
8	План лечения - множественный выбор	Пациент с 3 планами	Список планов для выбора
9	Обработка ошибки сети	Отключение интернета	Данные в очередь, отправка после восстановления
10	Ротация журналов	Работа системы 32 дня	Старые файлы удалены
7.1.3. Нагрузочное тестирование
Цель: Проверка производительности под нагрузкой
Сценарии:
№	Сценарий	Параметры	Критерий успеха
1	Синхронизация большого объема	200 записей одновременно	Обработка за 8 минут
2	Длительная работа	Непрерывная работа 72 часа	Стабильная работа, утечек памяти нет
3	Пиковая нагрузка	50 записей каждые 2 минуты (1 час)	CPU < 15%, RAM < 200 МБ
4	Одновременная работа всех филиалов	5 экземпляров синхронно	Все филиалы работают стабильно
7.1.4. Тестирование отказоустойчивости
Сценарии:
№	Сценарий	Действие	Ожидаемый результат
1	Отключение сети	Разрыв соединения на 5 минут	Данные в очередь, отправка после восстановления
2	Перезагрузка ПК	Перезагрузка во время синхронизации	Автозапуск, продолжение работы
3	Недоступность Битрикс24	Симуляция 500 ошибки	Повторные попытки, сохранение в очередь
4	Недоступность БД Ident	Остановка SQL Server	Логирование ошибки, попытки переподключения
5	Переполнение диска	Диск заполнен на 99%	Предупреждение, ограничение логирования
7.1.5. Приемочные испытания
Проводятся комиссией Заказчика по завершении этапа 3.
Метод: Проверка выполнения всех критериев приемки (раздел 5)
Результат: Акт приемки системы в эксплуатацию
7.2. Порядок проведения испытаний
Последовательность:
1.	Модульное тестирование (в процессе разработки) → Устранение дефектов → Повторное тестирование
2.	Интеграционное тестирование (после завершения разработки) → Устранение дефектов → Повторное тестирование
3.	Нагрузочное тестирование (после успешного интеграционного) → Оптимизация → Повторное тестирование
4.	Тестирование отказоустойчивости (параллельно нагрузочному) → Доработка → Повторное тестирование
5.	Пилотная эксплуатация (этап 2) → Корректировки → Повторная проверка
6.	Приемочные испытания (этап 3) → Акт приемки
Критерии завершения тестирования:
•	Все тест-кейсы выполнены
•	Критичные дефекты отсутствуют
•	Некритичные дефекты задокументированы и согласованы с Заказчиком
•	Протокол тестирования оформлен и утвержден
7.3. Документация по результатам испытаний
Обязательные документы:
1.	Протокол модульного тестирования - отчет о покрытии кода тестами
2.	Протокол интеграционного тестирования - результаты по каждому сценарию
3.	Отчет о нагрузочном тестировании - графики производительности, метрики
4.	Отчет о тестировании отказоустойчивости - результаты симуляций сбоев
5.	Отчет о пилотной эксплуатации - обратная связь от кураторов, статистика работы
6.	Акт приемочных испытаний - итоговый документ с подписями сторон
________________________________________
8. ТРЕБОВАНИЯ К ДОКУМЕНТАЦИИ
8.1. Проектная документация
Обязательные документы:
1.	Техническое задание (настоящий документ)
2.	Аналитический отчет по результатам обследования
3.	Спецификация требований к интеграции
4.	Схемы маппинга данных
5.	Архитектурное решение (диаграммы компонентов, последовательностей, развертывания)
8.2. Эксплуатационная документация
Обязательные документы:
1.	Руководство администратора - установка, настройка, мониторинг, обновление
2.	Руководство пользователя - инструкции для кураторов по работе с данными в Битрикс24
3.	Описание API - документация REST API для получения планов лечения
4.	Руководство по устранению неполадок - типовые проблемы и решения
5.	Регламент технического обслуживания - плановые работы, резервное копирование
8.3. Исходный код
Требования:
•	Исходный код должен быть передан Заказчику
•	Код должен содержать комментарии на русском языке
•	Должна быть предоставлена инструкция по сборке проекта
•	Должны быть переданы все зависимости и библиотеки
________________________________________

11. ОСОБЫЕ УСЛОВИЯ
11.1. Ограничения и допущения
Ограничения:
1.	Интеграция односторонняя (Ident → Битрикс24), обратная синхронизация не предусмотрена
2.	Система не синхронизирует файлы и медиа-контент (рентгеновские снимки, фотографии)
3.	Исторические данные синхронизируются только за последние 7 дней при первом запуске
4.	Количество запросов к API Битрикс24 ограничено тарифным планом (обычно 2 запроса/сек)
Допущения:
1.	Структура БД Ident остается стабильной в период эксплуатации
2.	Сервисные ПК имеют стабильное интернет-соединение (≥ 1 Мбит/с)
3.	Операционная система: Windows 10/11 или Windows Server 2016+
4.	Битрикс24 доступен без VPN или прокси-серверов
________________________________________
12. ПРИЛОЖЕНИЯ
Приложение А. Глоссарий
Термин	Определение
Ident	Стоматологическая информационная система
Битрикс24	Облачная CRM-система
Webhook	Механизм передачи данных через HTTP-запросы
Сервисный ПК	Рабочая станция для развертывания интеграционного модуля
Куратор лечения	Специалист, координирующий процесс лечения пациента
Маппинг	Соответствие полей между системами
Инкрементальная синхронизация	Передача только новых и измененных данных


СПЕЦИФИКАЦИЯ ТРЕБОВАНИЙ К ИНТЕГРАЦИИ
Система Ident → CRM Битрикс24
________________________________________
1. ОБЩИЕ ПОЛОЖЕНИЯ
1.1. Назначение документа
Настоящий документ определяет полный перечень функциональных и нефункциональных требований к интеграционному решению между системой управления стоматологической клиникой Ident и CRM-системой Битрикс24.
1.2. Область применения
Интеграционное решение предназначено для автоматической синхронизации данных о записях пациентов и планах лечения между пятью филиалами медицинской организации и единой CRM-системой Битрикс24.
1.3. Термины и определения
Термин	Определение
Ident	Стоматологическая информационная система, используемая в филиалах
Битрикс24	Облачная CRM-система для централизованного управления
Webhook	Механизм передачи данных через HTTP-запросы к API Битрикс24
Сервисный ПК	Рабочая станция в филиале, на которой развернут интеграционный модуль
Синхронизация	Процесс передачи данных из Ident в Битрикс24
Маппинг	Соответствие полей между системами Ident и Битрикс24
________________________________________
2. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ
2.1. Общие функциональные требования
1. Система должна обеспечивать автоматическую односторонюю синхронизацию данных из Ident в Битрикс24.
2. Система должна поддерживать работу с пятью филиалами, расположенными на четырех базах данных.
3. Система должна корректно идентифицировать принадлежность данных к конкретному филиалу, включая случай совместного размещения двух филиалов на одной БД.
4. Система должна функционировать на сервисных ПК в каждом филиале без необходимости развертывания централизованного сервера интеграции.
5. Система должна использовать механизм webhook для передачи данных в API Битрикс24.
________________________________________
2.2. Требования к синхронизации ЗАПИСЕЙ (Receptions)
2.2.1. Состав синхронизируемых данных
1. Система должна синхронизировать следующие поля записей:
№	Поле Ident	Поле Битрикс24	Обязательность
1	ID Записи	Уникальный идентификатор	Обязательное
2	Начало приема	Дата/время начала	Обязательное
3	Окончание приема	Дата/время окончания	Обязательное
4	Номер карты	Номер карты пациента	Обязательное
5	Фамилия	Фамилия пациента	Обязательное
6	Имя	Имя пациента	Обязательное
7	Отчество	Отчество пациента	Необязательное
8	Телефон	Телефон	Обязательное
9	Фамилия врача	Фамилия врача	Обязательное
10	Имя врача	Имя врача	Обязательное
11	Отчество врача	Отчество врача	Необязательное
12	Специальность	Специальность врача	Обязательное
13	Кабинет	Кабинет	Необязательное
14	Филиал	Филиал	Обязательное
15	Услуга	Услуги (массив)	Необязательное
16	Статус	Статус записи	Обязательное
17	Сумма	Сумма	Необязательное
18	Время создания записи	Дата создания	Обязательное
19	Пациент пришел	Отметка о приходе	Необязательное
20	Прием начат	Время начала приема	Необязательное
21	Прием завершен	Время завершения	Необязательное
22	Запись отменена	Дата отмены	Необязательное
23	Причина отмены	Причина отмены	Необязательное
24	Комментарий	Комментарий	Необязательное
25	Источник записи	Источник	Необязательное
2.2.2. Правила синхронизации
1. Система должна создавать новую запись в Битрикс24 при создании записи в Ident.
2. Система должна обновлять существующую запись в Битрикс24 при изменении статуса записи в Ident.
3. Система должна обновлять запись в Битрикс24 при изменении любых ключевых полей (время, врач, услуги, сумма).
4. Система должна поддерживать следующие статусы записей:
•	Запланирован
•	Пациент пришел
•	В процессе
•	Завершен
•	Завершен (счет выдан)
•	Отменен
5. При отмене записи система должна передавать причину отмены в Битрикс24.
6. Система должна поддерживать агрегацию нескольких услуг в рамках одной записи и передавать их списком.
________________________________________
2.3. Требования к синхронизации ПЛАНОВ ЛЕЧЕНИЯ
2.3.1. Состав синхронизируемых данных
1. Система должна синхронизировать следующие поля планов лечения:
№	Поле Ident	Поле Битрикс24	Обязательность
1	ID плана	Уникальный идентификатор	Обязательное
2	Название плана	Название	Обязательное
3	Пациент (ФИО)	ФИО пациента	Обязательное
4	Врач (ФИО)	ФИО врача	Обязательное
5	Этап	Этап лечения	Необязательное
6	Порядок этапа	Номер этапа	Необязательное
7	Элемент плана	Элемент	Необязательное
8	Услуга	Услуги (массив)	Обязательное
9	Статус выполнения	Статус	Обязательное
10	Цена	Цена услуги	Обязательное
11	Скидка	Размер скидки	Необязательное
12	Итого	Итоговая стоимость	Обязательное
2.3.2. Правила синхронизации
1. Система должна создавать новую запись плана лечения в Битрикс24 при создании плана в Ident.
2. Система должна обновлять план лечения в Битрикс24 при изменении статуса выполнения услуг.
3. Система должна поддерживать следующие статусы выполнения:
•	Не выполнено
•	Выполнено
•	Выполнено и оплачено
4. Система должна передавать все услуги плана лечения с указанием этапов и элементов плана.
5. Система должна пересчитывать и передавать общую стоимость плана лечения с учетом скидок.
________________________________________
2.4. Требования к обработке данных
2.4.1. Валидация данных
1. Система должна проверять наличие всех обязательных полей перед отправкой данных в Битрикс24.
2. Система должна проверять корректность форматов данных:
•	Даты и время в формате ISO 8601 (YYYY-MM-DDTHH:MM:SS)
•	Телефонные номера в формате +7XXXXXXXXXX
•	Числовые значения (суммы, ID) на корректность типа данных
3. При обнаружении некорректных данных система должна:
•	Зафиксировать ошибку в журнале
•	Пропустить некорректную запись
•	Продолжить обработку следующих записей
4. Система должна нормализовать текстовые данные:
•	Удалять лишние пробелы
•	Приводить ФИО к единому формату (первая буква заглавная)
•	Очищать спецсимволы из телефонных номеров
2.4.2. Идентификация и дедупликация
1. Система должна использовать уникальный идентификатор записи из Ident для предотвращения дублирования в Битрикс24.
2. Формат уникального идентификатора должен включать:
•	ID филиала
•	ID записи/плана
•	Формат: [FILIAL_ID]_[RECORD_ID] (например: F1_12345)
3. Система должна проверять наличие записи в Битрикс24 перед созданием новой:
•	Если запись существует → выполнить обновление
•	Если запись не существует → создать новую
2.4.3. Обработка филиала
1. Система должна корректно определять филиал для каждой записи с использованием следующего алгоритма:
1.	Проверить филиал через заказ
2.	Если не найден → проверить филиал через кабинет 
3.	Если не найден → установить значение "Не указан" и зафиксировать предупреждение в журнале
2. Система должна передавать название филиала в текстовом виде:
•	Филиал Абжалилова
•	Филиал Амирхана
•	Филиал Салимжанова
•	Филиал Миннуллина
•	Филиал Фучика
________________________________________
2.5. Требования к взаимодействию с API Битрикс24
2.5.1. Использование Webhook
1. Система должна использовать входящий webhook Битрикс24 для передачи данных.
2. Система должна поддерживать следующие методы API Битрикс24:
•	crm.deal.add - создание лида
•	crm. deal.update - обновление лида
•	crm. deal.get - получение данных лида
3. Система должна формировать тело запроса в формате JSON с соблюдением спецификации API Битрикс24.
4. Система должна включать в запрос все необходимые поля согласно документации Битрикс24 REST API.
2.5.2. Обработка ответов API
1. Система должна корректно обрабатывать следующие HTTP-коды ответов:
•	200 OK → Успешное выполнение запроса
•	400 Bad Request → Ошибка в формате данных, зафиксировать в журнале
•	401 Unauthorized → Ошибка авторизации, прекратить синхронизацию, уведомить администратора
•	429 Too Many Requests → Превышен лимит запросов, применить экспоненциальную задержку
•	500 Internal Server Error → Ошибка сервера Битрикс24, повторить запрос через установленный интервал
2. Система должна извлекать из ответа API:
•	ID созданной/обновленной сущности в Битрикс24
•	Статус выполнения операции
•	Описание ошибки при неудачном выполнении
3. При получении ошибки от API система должна:
•	Зафиксировать детали ошибки в журнале (время, тип ошибки, тело запроса)
•	Сохранить неудачный запрос для повторной отправки
•	Продолжить обработку следующих записей
________________________________________
2.6. Требования к журналированию и мониторингу
1. Система должна вести детальный журнал событий, включающий:
•	Время события
•	Тип события (создание, обновление, ошибка)
•	ID записи в Ident
•	ID записи в Битрикс24
•	Результат операции
•	Описание ошибки (при наличии)
2. Журнал должен храниться в текстовом формате с ротацией файлов:
•	Новый файл журнала создается ежедневно
•	Формат имени: integration_log_YYYY-MM-DD.txt
•	Глубина хранения: 30 дней
•	Файлы старше 30 дней удаляются автоматически
3. Система должна предоставлять статистику синхронизации:
•	Количество обработанных записей за период
•	Количество успешных синхронизаций
•	Количество ошибок
•	Средняя скорость обработки записей
4. Система должна отправлять уведомления администратору при критических событиях:
•	Потеря соединения с БД Ident
•	Ошибка авторизации в Битрикс24
•	Превышение порога ошибок (>10% за час)
________________________________________
3. НЕФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ
3.1. Параметры синхронизации данных
3.1.1. Режимы синхронизации
1. Система должна работать в режиме периодической синхронизации с настраиваемым интервалом.
2. Рекомендуемые интервалы синхронизации:
•	Записи каждые 2 минуты
•	Планы лечения каждые 2 минуты
•	2.1. Интервал синхронизации должен быть настраиваемым через конфигурационный файл без изменения кода.
3. Система должна поддерживать ручной запуск синхронизации по команде администратора.
3.1.2. Объемы синхронизируемых данных
1. Система должна обрабатывать следующие объемы данных за один цикл синхронизации:
Сущность	Ожидаемый объем за интервал	Максимальный объем
Записи	10-50 записей за 5 минут	200 записей
Планы лечения	5-20 планов за час	100 планов
2. При превышении максимального объема система должна:
•	Разбить обработку на несколько итераций
•	Обрабатывать данные пакетами по 50 записей
•	Делать паузу 1 секунду между пакетами
3.1.3. Стратегия синхронизации
1. Система должна синхронизировать только изменённые/новые данные (инкрементальная синхронизация).
2. Для определения изменений система должна использовать:
•	Поле DateTimeAdded для новых записей
•	Поле DateTimeChanged для измененных записей
•	Временную метку последней успешной синхронизации
3. При первом запуске (начальная синхронизация) система должна:
•	Синхронизировать данные за последние 7 дней
•	Обрабатывать пакетами по 50 записей
•	Выполнять с пониженным приоритетом (увеличенные паузы между пакетами)
________________________________________
3.2. Требования к производительности
3.2.1. Время обработки
1. Обработка одной записи (включая формирование запроса и отправку в Битрикс24) не должна превышать 2 секунды.
2. Полный цикл синхронизации записей (50 записей) не должен превышать 2 минуты.
3. Время запуска интеграционного модуля не должно превышать 10 секунд.
4. Время обращения к БД Ident для выборки данных не должно превышать 1 секунды для пакета из 50 записей.
3.2.2. Использование ресурсов сервисного ПК
1. Интеграционный модуль в режиме ожидания (между циклами синхронизации) должен потреблять:
•	CPU: не более 1-2%
•	RAM: не более 100 МБ
•	Дисковое пространство: не более 500 МБ (включая журналы за 30 дней)
2. Интеграционный модуль в режиме активной синхронизации должен потреблять:
•	CPU: не более 10-15%
•	RAM: не более 200 МБ
•	Сетевой трафик: не более 1 Мбит/с
3. Система не должна создавать значительную дополнительную нагрузку на БД Ident:
•	Количество одновременных подключений: не более 1
•	Сложные запросы с JOIN: оптимизированы и используют индексы
•	Блокировки таблиц: отсутствуют
3.2.3. Сетевые требования
1. Система должна работать при следующих параметрах сети:
•	Скорость интернет-соединения: от 1 Мбит/с
•	Задержка (ping) до Битрикс24: до 200 мс
•	Допустимая потеря пакетов: до 1%
2. Система должна корректно обрабатывать временные сбои связи:
•	Автоматическая повторная попытка через 30 секунд
•	Максимальное количество повторов: 3
•	Сохранение неотправленных данных для последующей передачи
________________________________________
3.3. Требования к надежности
3.3.1. Доступность системы
1. Целевая доступность интеграционного модуля: 99% (допустимый простой не более 7 часов в месяц).
2. Система должна автоматически перезапускаться после критических ошибок:
•	Необработанное исключение в коде
•	Потеря соединения с БД более 5 минут
•	Ошибка сети более 5 минут
3. Максимальное время восстановления после сбоя: 5 минут.
3.3.2. Обработка ошибок
1. Система должна использовать механизм повторных попыток для временных ошибок:
•	Ошибки сети: повтор через 30 сек, 1 мин, 5 мин
•	Ошибки API (429, 500): повтор через 1 мин, 5 мин, 15 мин
•	Ошибки БД: повтор через 10 сек, 30 сек, 1 мин
2. Система должна предотвращать потерю данных при аварийном завершении:
•	Сохранение состояния синхронизации каждые 10 секунд
•	Использование транзакций при работе с очередью
•	Контрольные точки для возможности возобновления
________________________________________
3.4. Требования к безопасности
3.4.1. Защита данных
1. Все данные должны передаваться по защищенному протоколу HTTPS (TLS 1.2+).
2. Webhook-токен Битрикс24 должен храниться в зашифрованном виде в конфигурационном файле.
3. Учетные данные для подключения к БД Ident должны храниться в защищенном хранилище с ограниченным доступом.
4. Журналы не должны содержать персональных данных пациентов (ФИО, телефоны) в открытом виде:
•	Вместо ФИО логировать только ID пациента
•	Вместо телефона логировать маскированное значение (+7XXX***XX-XX)
5. Доступ к конфигурационным файлам и журналам должен быть ограничен:
•	Права доступа: только для учетной записи службы
•	Запрет на чтение для обычных пользователей ПК
3.4.2. Аутентификация и авторизация
1. Webhook Битрикс24 должен включать уникальный токен доступа для предотвращения несанкционированных запросов.
2. Система должна проверять валидность webhook-токена перед каждым запросом к API.
3. При компрометации токена должна быть возможность его замены через конфигурационный файл без изменения кода.
3.4.3. Аудит безопасности
1. Система должна фиксировать в журнале все события безопасности:
•	Попытки несанкционированного доступа
•	Ошибки авторизации в API Битрикс24
•	Изменения конфигурационных файлов
•	Неудачные попытки подключения к БД
2. Журналы безопасности должны храниться отдельно от основных журналов работы.
3.4.4. Преимущества размещения на сервисном ПК
1. Размещение интеграционного модуля на сервисном ПК обеспечивает следующие преимущества безопасности:
1.	Изоляция данных:
o	Данные не передаются на внешние серверы интеграции
o	Обработка данных происходит в пределах локальной сети филиала
o	Снижение риска утечки данных при передаче
2.	Контроль доступа:
o	Физический контроль доступа к серверу в пределах филиала
o	Использование существующих политик безопасности организации
o	Отсутствие необходимости в дополнительных каналах доступа
3.	Минимизация поверхности атаки:
o	Нет открытых портов для внешних подключений
o	Только исходящие HTTPS-соединения к Битрикс24
o	Отсутствие внешних точек входа
________________________________________
3.5. Требования к масштабируемости и расширяемости
3.5.1. Масштабируемость
1. Система должна поддерживать увеличение количества филиалов до 10 без изменения архитектуры.
2. Система должна справляться с увеличением объемов данных в 2 раза без деградации производительности.
3. Система должна поддерживать горизонтальное масштабирование:
•	Возможность развертывания независимых экземпляров на каждом сервисном ПК
•	Отсутствие конфликтов при одновременной работе нескольких экземпляров
3.5.2. Расширяемость
1. Архитектура системы должна позволять добавление новых синхронизируемых сущностей без изменения базовых компонентов.
2. Система должна поддерживать подключение дополнительных обработчиков данных через модульную структуру.
3. Формат конфигурационного файла должен позволять добавление новых параметров без нарушения обратной совместимости.
________________________________________
4. АРХИТЕКТУРНЫЕ РЕШЕНИЯ И ОБОСНОВАНИЯ
4.1. Размещение на сервисных ПК
Решение: Интеграционный модуль развертывается на существующих рабочих станциях (сервисных ПК) в каждом филиале.
Преимущества:
1.	Уменьшение задержки данных:
o	Прямой доступ к локальной БД Ident без сетевых задержек
o	Минимальная задержка между изменением данных в Ident и отправкой в Битрикс24
o	Отсутствие необходимости в репликации данных на централизованный сервер
2.	Снижение затрат:
o	Отсутствие расходов на приобретение и настройку выделенного сервера интеграции
o	Использование существующих ресурсов инфраструктуры
o	Снижение затрат на администрирование и поддержку
3.	Упрощение архитектуры:
o	Независимая работа модулей в каждом филиале
o	Отсутствие единой точки отказа
o	Простота масштабирования при добавлении новых филиалов
4.	Безопасность:
o	Данные обрабатываются и передаются в пределах одного ПК
o	Отсутствие передачи данных между филиалами
o	Использование существующих механизмов физической и сетевой безопасности
________________________________________
4.2. Использование Webhook Битрикс24
Решение: Передача данных в Битрикс24 осуществляется через входящие webhook.
Преимущества:
1.	Простота интеграции:
o	Не требуется OAuth-авторизация
o	Простая настройка через веб-интерфейс Битрикс24
o	Быстрое развертывание и тестирование
2.	Безопасность:
o	Уникальный токен доступа для каждого webhook
o	Передача данных по защищенному HTTPS-протоколу
o	Возможность быстрой ротации токенов при компрометации
3.	Гибкость:
o	Возможность создания отдельных webhook для разных филиалов
o	Простота мониторинга и отладки
o	Независимость работы модулей в филиалах
Выбранное решение оптимально для данного проекта с точки зрения соотношения простоты, безопасности и функциональности.
________________________________________
5. ОГРАНИЧЕНИЯ И ДОПУЩЕНИЯ
5.1. Ограничения
1. Синхронизация данных односторонняя (Ident → Битрикс24). Обратная синхронизация не предусмотрена.
2. Система не предоставляет графический интерфейс для ручного управления синхронизацией (только веб-интерфейс мониторинга).
3. Количество одновременных запросов к API Битрикс24 ограничено лимитами тарифного плана (2 запроса в секунду).
4. Синхронизация историчных данных выполняется только при первом запуске (за последние 7 дней).
5. Система не поддерживает синхронизацию файлов и медиа-контента (рентгеновские снимки, фотографии и т.д.).
5.2. Допущения
1. Сервисные ПК имеют стабильное интернет-соединение со скоростью не менее 1 Мбит/с.
2. На сервисных ПК установлена операционная система Windows 10/11 или Windows Server 2016+.
3. Структура БД Ident остается стабильной и не подвергается критическим изменениям в период эксплуатации интеграции.
________________________________________
6. ПЛАН ТЕСТИРОВАНИЯ
6.1. Модульное тестирование
•	Тестирование модуля подключения к БД Ident
•	Тестирование модуля формирования webhook-запросов
•	Тестирование модуля обработки ответов API
•	Тестирование модуля валидации и нормализации данных
6.2. Интеграционное тестирование
•	Тестирование полного цикла синхронизации записи
•	Тестирование обработки ошибок API
•	Тестирование механизма очередей
•	Тестирование идентификации филиалов для БД с двумя филиалами
6.3. Нагрузочное тестирование
•	Синхронизация 200 записей
•	Одновременная синхронизация из всех 5 филиалов
•	Тестирование при ограниченной пропускной способности сети
6.4. Тестирование отказоустойчивости
•	Отключение сети во время синхронизации
•	Перезагрузка ПК во время синхронизации
•	Недоступность API Битрикс24
•	Недоступность БД Ident




СХЕМЫ МАППИНГА ДАННЫХ
Интеграция системы Ident с CRM Битрикс24
________________________________________
1. ВВЕДЕНИЕ
1.1. Назначение документа
Настоящий документ содержит детальные схемы соответствия полей (маппинг) между системой Ident и CRM Битрикс24 для всех основных синхронизируемых сущностей. Документ определяет правила преобразования данных, форматы, алгоритмы обработки и валидации для обеспечения корректной синхронизации информации между филиалами.
1.2. Основные синхронизируемые сущности
В рамках интеграционного решения синхронизируются следующие сущности:
1.	Запись на приём → Сделка в Битрикс24
2.	План лечения → Локальное приложение в Битрикс24
1.3. Направление синхронизации
Односторонняя синхронизация: Ident → Битрикс24
Обратная синхронизация не предусмотрена.
________________________________________
2. МАППИНГ СУЩНОСТИ "ЗАПИСЬ НА ПРИЁМ"
2.1. Общая схема маппинга
Сущность в Ident: Receptions (Записи)
Сущность в Битрикс24: Deal (Сделка)
Метод API для создания: crm.deal.add
Метод API для обновления: crm.deal.update
2.2. Детальная таблица соответствия полей
№	Поле Ident	Тип данных Ident	Поле Битрикс24	Тип в Битрикс24	Обязательность	Примечание
1	ID Записи	INT	UF_CRM_RECEPTION_ID	string	Обязательное	Уникальный идентификатор формата F[N]_[ID]
2	Начало приема	DATETIME	UF_CRM_START_TIME	datetime	Обязательное	Формат ISO 8601
3	Окончание приема	DATETIME	UF_CRM_END_TIME	datetime	Обязательное	Формат ISO 8601
4	Фамилия	NVARCHAR	TITLE	string	Обязательное	Часть названия сделки
5	Имя	NVARCHAR	TITLE	string	Обязательное	Часть названия сделки
6	Отчество	NVARCHAR	TITLE	string	Необязательное	Часть названия сделки
7	Телефон	NVARCHAR/BIGINT	PHONE	crm_multifield	Обязательное	Телефон клиента
8	Фамилия врача	NVARCHAR	UF_CRM_DOCTOR_SURNAME	string	Обязательное	-
9	Имя врача	NVARCHAR	UF_CRM_DOCTOR_NAME	string	Обязательное	-
10	Отчество врача	NVARCHAR	UF_CRM_DOCTOR_PATRONYMIC	string	Необязательное	-
11	Специальность	NVARCHAR	UF_CRM_DOCTOR_PROFESSION	string	Обязательное	-
12	Филиал	NVARCHAR	UF_CRM_FILIAL	string	Обязательное	Определяется через COALESCE
13	Услуга	NVARCHAR	UF_CRM_SERVICES	string/text	Необязательное	Список через запятую
14	Статус	VARCHAR	STAGE_ID	crm_status	Обязательное	Маппинг статусов (см. раздел 2.4)
15	Сумма	DECIMAL	OPPORTUNITY	double	Необязательное	Сумма сделки в рублях
16	Причина отмены	NVARCHAR	UF_CRM_CANCEL_REASON	string/text	Необязательное	Заполняется при отмене
17	Комментарий	NVARCHAR	COMMENTS	text	Необязательное	Дополнительная информация
________________________________________
2.3. Логика поиска и создания клиентов в Битрикс24
Общий принцип: Система использует телефон пациента как основной идентификатор для поиска существующих записей в Битрикс24 и предотвращения дублирования данных.
2.3.1. Алгоритм обработки записи
При получении новой записи из Ident система выполняет следующую последовательность действий:
Этап 1. Поиск клиента по телефону
Система выполняет поиск в CRM Битрикс24 по нормализованному номеру телефона пациента. Поиск охватывает две сущности:
•	Контакты (Contact)
•	Лиды (Lead)
Используется метод поиска по телефону с полным совпадением нормализованного значения.
Этап 2. Анализ результатов поиска
Возможны три варианта результата поиска:
Вариант А: Клиент не найден
•	В Битрикс24 отсутствуют контакты и лиды с указанным номером телефона
•	Действие: Создание нового контакта с данными пациента
•	Далее: Создание сделки, привязанной к новому контакту
Вариант Б: Найден лид
•	В системе существует лид (потенциальный клиент) с указанным телефоном
•	Действие: Автоматическая конвертация лида в контакт и сделку
•	Процесс конвертации: 
1.	Лид преобразуется в контакт с сохранением всех данных
2.	Одновременно создается сделка, связанная с контактом
3.	Данные из записи Ident заполняют поля созданной сделки
4.	Исходный лид переводится в статус "Конвертирован"
Вариант В: Найден контакт
•	В системе уже существует контакт с указанным телефоном
•	Подэтап 1: Поиск существующей сделки 
o	Система проверяет наличие сделок, связанных с найденным контактом
o	Поиск выполняется по уникальному идентификатору записи
Подвариант В1: Сделка с таким ID уже существует
•	Найдена сделка с идентификатором формата  для текущей записи
•	Действие: Обновление существующей сделки
•	Обновляемые поля: 
o	Статус записи
o	Сумма
o	Услуги
o	Временные метки (время прихода, начала, завершения)
o	Причина отмены (при наличии)
o	Комментарий
•	Неизменяемые поля: Название сделки, телефон, врач, филиал (первоначальные данные)
Подвариант В2: Сделка не найдена
•	Контакт существует, но сделки с таким идентификатором записи нет
•	Действие: Создание новой сделки, привязанной к существующему контакту
•	Заполнение: Все поля заполняются данными из записи Ident
2.3.2. Правила работы с дублями
Защита от дублирования:
1.	По телефону: Уникальный телефон пациента предотвращает создание множественных контактов для одного человека
2.	По ID записи: Уникальный идентификатор формата гарантирует, что одна запись из Ident создаст только одну сделку в Битрикс24
3.	Повторная синхронизация: При повторной обработке той же записи (например, при изменении статуса) система найдет существующую сделку и обновит её, не создавая дубликат
2.3.3. Сценарии использования
Сценарий 1: Новый пациент, первое посещение
•	Пациент впервые записался на прием
•	Телефон отсутствует в Битрикс24
•	Результат: Создается контакт + создается сделка
Сценарий 2: Лид из рекламы пришел на прием
•	Пациент ранее оставил заявку (создан лид)
•	Теперь записался на прием в Ident
•	Результат: Лид конвертируется в контакт + создается сделка с данными приема
Сценарий 3: Постоянный пациент, новая запись
•	Пациент уже есть в базе (контакт существует)
•	Создается новая запись на прием
•	Результат: Создается новая сделка для существующего контакта
Сценарий 4: Изменение статуса записи
•	Запись уже синхронизирована (сделка создана)
•	В Ident изменился статус (например, "Пациент пришел" → "Прием завершен")
•	Результат: Существующая сделка обновляется новым статусом и временными метками
Сценарий 5: Отмена записи
•	Запись была синхронизирована
•	Пациент отменил прием
•	Результат: Сделка обновляется: статус → "Отменен", добавляется причина отмены
2.3.4. Приоритеты при обновлении
Всегда обновляются:
•	Статус записи
•	Временные метки (пришел, начат, завершен, отменен)
•	Сумма
•	Услуги
•	Комментарий
Обновляются только при заполнении:
•	Причина отмены (если запись отменена)
Никогда не обновляются (сохраняются первоначальные):
•	Название сделки
•	Уникальный идентификатор
•	Данные пациента (ФИО, телефон)
•	Данные врача
•	Филиал
•	Дата и время приема
Такой подход обеспечивает стабильность исторических данных при отслеживании изменений статуса записи.
________________________________________
2.4. Правила формирования названия сделки (TITLE)
Формула:
TITLE = "[Фамилия] [Имя] [Отчество] - [Начало приема]"
Примеры:
Исходные данные	Результат
Иванов Иван Иванович, 2024-12-30 10:00	Иванов Иван Иванович - 30.12.2024 10:00
Петрова Мария, 2024-12-30 14:30	Петрова Мария - 30.12.2024 14:30
Сидоров Петр Александрович, 2024-12-31 09:00	Сидоров Петр Александрович - 31.12.2024 09:00
Алгоритм формирования:
Система автоматически формирует название сделки путем объединения фамилии, имени и отчества пациента (если указано) с датой и временем начала приема. Дата форматируется в стандартный российский формат (ДД.ММ.ГГГГ), время отображается в формате 24 часа (ЧЧ:ММ).
Правила обработки:
•	Лишние пробелы удаляются
•	Первая буква каждого слова ФИО - заглавная
•	Дата всегда в формате DD.MM.YYYY
•	Время всегда в формате HH:MM
•	Если отчество отсутствует - не добавляется
________________________________________
2.5. Маппинг статусов записи
Система статусов:
Статусы и состояния записей из Ident преобразуются в стадии воронки продаж Битрикс24 с использованием комплексной логики, учитывающей тип услуги, наличие плана лечения и текущее состояние записи.
2.5.1. Описание стадий воронки Битрикс24
Стадия	STAGE_ID	Описание	Условия попадания
Запись на консультацию	C1:CONSULTATION_SCHEDULED	Клиент записан на консультацию	Услуга = "Консультация" + статус не завершен
Консультация проведена	C1:CONSULTATION_DONE	Консультация успешно проведена	Услуга = "Консультация" + запись завершена
Презентация плана лечения	C1:PLAN_PRESENTATION	Планируется презентация плана лечения	Устанавливается куратором вручную
Лист ожидания	C1:WAITING_LIST	Клиент в листе ожидания	Сформировано из листа ожидания Ident
Получена предоплата	C1:PREPAYMENT_RECEIVED	Получена предоплата за лечение	Устанавливается куратором вручную
Лечение	C1:TREATMENT	Идет процесс лечения	Есть активный план лечения ИЛИ услуга ≠ "Консультация" + в процессе
Успешно	C1:WON	Лечение завершено успешно	План лечения полностью выполнен ИЛИ запись завершена со счетом
Не успешно	C1:LOSE	Запись отменена/лечение не завершено	Запись отменена
2.5.2. Логика определения стадии для записи
Алгоритм присвоения стадии выполняется в следующем приоритете:
Приоритет 1: Проверка отмены
•	Условие: Поле "Запись отменена" (ReceptionCanceled) заполнено
•	Стадия: C1:LOSE (Не успешно)
•	Действие: Добавляется причина отмены в поле UF_CRM_CANCEL_REASON
Приоритет 2: Проверка типа услуги "Консультация"
Подприоритет 2.1: Консультация завершена
•	Условие: 
o	Услуга содержит слово "Консультация"
o	Поле "Прием завершен" (ReceptionEnded) заполнено ИЛИ "Счет выдан" (CheckIssued) заполнено
•	Стадия: C1:CONSULTATION_DONE (Консультация проведена)
Подприоритет 2.2: Консультация запланирована/в процессе
•	Условие: 
o	Услуга содержит слово "Консультация"
o	Запись НЕ завершена
•	Стадия: C1:CONSULTATION_SCHEDULED (Запись на консультацию)
Приоритет 3: Проверка наличия плана лечения
Подприоритет 3.1: План лечения полностью выполнен
•	Условие: 
o	Есть связь с планом лечения
o	Все услуги в плане имеют статус "Выполнено и оплачено"
•	Стадия: C1:WON (Успешно)
Подприоритет 3.2: План лечения в процессе
•	Условие: 
o	Есть связь с планом лечения
o	План активен (не все услуги выполнены)
•	Стадия: C1:TREATMENT (Лечение)
Приоритет 4: Обычная запись на лечение
Подприоритет 4.1: Лечение завершено успешно
•	Условие: 
o	Услуга НЕ "Консультация"
o	Поле "Счет выдан" (CheckIssued) заполнено
•	Стадия: C1:WON (Успешно)
Подприоритет 4.2: Лечение завершено без счета
•	Условие: 
o	Услуга НЕ "Консультация"
o	Поле "Прием завершен" (ReceptionEnded) заполнено
o	Поле "Счет выдан" (CheckIssued) НЕ заполнено
•	Стадия: C1:TREATMENT (Лечение)
•	Примечание: Ожидается выдача счета
Подприоритет 4.3: Лечение в процессе
•	Условие: 
o	Услуга НЕ "Консультация"
o	Поле "Прием начат" (ReceptionStarted) заполнено
•	Стадия: C1:TREATMENT (Лечение)
Подприоритет 4.4: Пациент пришел на лечение
•	Условие: 
o	Услуга НЕ "Консультация"
o	Поле "Пациент пришел" (PatientAppeared) заполнено
•	Стадия: C1:TREATMENT (Лечение)
Приоритет 5: Запись по умолчанию
•	Условие: Ни одно из вышеперечисленных условий не выполнено
•	Стадия: C1:CONSULTATION_SCHEDULED (Запись на консультацию)
•	Примечание: Считается, что любая новая запись изначально является записью на консультацию
2.5.3. Стадии, устанавливаемые вручную
Следующие стадии НЕ устанавливаются автоматически при синхронизации из Ident. Они управляются вручную куратором лечения в Битрикс24:
C1:PLAN_PRESENTATION (Презентация плана лечения)
•	Куратор переводит сделку на эту стадию, когда назначена встреча для презентации плана лечения пациенту
•	Используется для отслеживания этапа согласования плана
C1:PREPAYMENT_RECEIVED (Получена предоплата)
•	Куратор переводит сделку на эту стадию после получения предоплаты от пациента
•	Используется для контроля финансовых обязательств пациента
C1:WAITING_LIST (Лист ожидания)
•	Используется для сделок, сформированных из листа ожидания Ident
•	Применяется, когда пациент готов начать лечение, но ожидает свободного времени врача
•	Примечание: Данная стадия будет использоваться при реализации интеграции листа ожидания
Важно: При автоматической синхронизации система НЕ изменяет стадию сделки, если она была вручную установлена куратором в одну из вышеперечисленных стадий. Это предотвращает случайный сброс важных маркеров бизнес-процесса.
2.5.4. Правила обновления стадии
Движение вперед по воронке:
Стадия может автоматически обновляться вперед по логике воронки:
•	CONSULTATION_SCHEDULED → CONSULTATION_DONE (когда консультация завершена)
•	CONSULTATION_DONE → TREATMENT (когда начато лечение)
•	TREATMENT → WON (когда лечение завершено успешно)
Движение назад по воронке:
Стадия НЕ может автоматически двигаться назад, за исключением:
•	Любая стадия → LOSE (при отмене записи)
Защита ручных стадий:
Если сделка находится в стадиях:
•	C1:PLAN_PRESENTATION
•	C1:PREPAYMENT_RECEIVED
•	C1:WAITING_LIST
Автоматическая синхронизация НЕ изменяет стадию, только обновляет данные сделки (сумму, услуги, комментарии).
________________________________________
2.6. Правила преобразования данных
2.6.1. Дата и время (DATETIME → datetime)
Исходный формат в Ident: YYYY-MM-DD HH:MM:SS (SQL Server DATETIME)
Целевой формат в Битрикс24: ISO 8601 YYYY-MM-DDTHH:MM:SS+03:00
Правила преобразования:
•	Между датой и временем добавляется символ "T" для соответствия стандарту ISO 8601
•	К значению добавляется информация о временной зоне (по умолчанию +03:00 для московского времени)
•	Точность сохраняется до секунд
•	Формат преобразования обеспечивает корректное отображение времени в Битрикс24
Пример преобразования:
Исходное значение	Результат
2024-12-30 10:00:00	2024-12-30T10:00:00+03:00
2024-12-30 14:30:45	2024-12-30T14:30:45+03:00
________________________________________
2.6.2. Телефон (NVARCHAR/BIGINT → crm_multifield)
Исходный формат в Ident:
•	79161234567 (BIGINT)
•	+7 (916) 123-45-67 (NVARCHAR)
•	8-916-123-45-67 (NVARCHAR)
Целевой формат в Битрикс24:
{
    "PHONE": [
        {
            "VALUE": "+79161234567",
            "VALUE_TYPE": "MOBILE"
        }
    ]
}
Алгоритм нормализации телефона:
Система выполняет следующие преобразования телефонного номера:
1.	Удаляются все символы кроме цифр и знака "+"
2.	Если номер начинается с "8", восьмерка заменяется на "+7"
3.	Если номер начинается с "7" без плюса, добавляется знак "+"
4.	Если номер состоит из 10 цифр без кода страны, автоматически добавляется "+7"
5.	Результат оформляется в формат multifield Битрикс24 с типом "MOBILE"
Примеры преобразования:
Исходное значение	Нормализованное	Формат Битрикс24
79161234567	+79161234567	{"PHONE":[{"VALUE":"+79161234567","VALUE_TYPE":"MOBILE"}]}
+7 (916) 123-45-67	+79161234567	{"PHONE":[{"VALUE":"+79161234567","VALUE_TYPE":"MOBILE"}]}
8-916-123-45-67	+79161234567	{"PHONE":[{"VALUE":"+79161234567","VALUE_TYPE":"MOBILE"}]}
________________________________________
2.6.3. Филиал (NVARCHAR → string)
Логика определения филиала:
COALESCE(oc_order.Name, oc_armchair.Name, 'Не указан') AS Филиал
Приоритет определения:
1.	Филиал из заказа (Orders → OwnCompanies)
2.	Филиал из кабинета (Armchairs → OwnCompanies)
3.	Значение по умолчанию: "Не указан"
Возможные значения:
•	Филиал Фучика 
•	Филиал Миннуллина 
•	Филиал Амирхана
•	Филиал Салимжанова 
•	Филиал Абжалилова 
•	Не указан (в случае отсутствия данных)
Правила передачи:
•	Передается как строка без дополнительного преобразования
•	Значение "Не указан" генерирует предупреждение в журнале
•	Используется для фильтрации и группировки в отчетах Битрикс24
________________________________________
2.6.5. Услуги (NVARCHAR → string/text)
Исходный формат: Множественные записи в таблице OrderServiceRelation
Целевой формат: Строка с перечислением услуг через запятую
Алгоритм агрегации:
SELECT STRING_AGG(si.Name, ', ') AS Услуги
FROM OrderServiceRelation osr
INNER JOIN ServiceItemPrices sip ON osr.ID_ServicePrices = sip.ID
INNER JOIN ServiceItems si ON sip.ID_ServiceItems = si.ID
WHERE osr.ID_Orders = @OrderID
Примеры:
Услуги в Ident	Результат в Битрикс24
1. Консультация	Консультация
1. Консультация 2. Лечение кариеса	Консультация, Лечение кариеса
1. Консультация 2. Лечение кариеса 3. Профессиональная чистка	Консультация, Лечение кариеса, Профессиональная чистка
Правила формирования:
•	Услуги перечисляются в порядке их следования в заказе
•	Разделитель: запятая с пробелом (, )
•	Максимальная длина строки: 3000 символов
•	При превышении лимита выполняется обрезка с добавлением текста "... (и ещё N услуг)", где N - количество оставшихся услуг
Логика обработки длинных списков:
При превышении лимита в 3000 символов система выполняет усечение строки до последней полной услуги, которая помещается в лимит. После этого добавляется информация о количестве услуг, которые не вошли в список.
________________________________________
2.6.6. Сумма (DECIMAL → double)
Исходный формат: DECIMAL(18, 10) в Ident
Целевой формат: double в Битрикс24
Правила преобразования:
•	Выполняется округление до 2 знаков после запятой
•	В качестве десятичного разделителя используется точка
•	Отрицательные значения не допускаются и заменяются на 0
•	Результат передается в формате double (число с плавающей точкой)
Формула расчета суммы:
SUM(osr.CountService * sip.Price - ISNULL(osr.DiscountSum, 0)) AS Сумма
Пример:
Услуга	Количество	Цена	Скидка	Итого
Консультация	1	1000	0	1000
Лечение кариеса	2	5000	500	9500
ИТОГО				10500
________________________________________
________________________________________
3. МАППИНГ СУЩНОСТИ "ПЛАН ЛЕЧЕНИЯ"
3.1. Общая схема реализации
Сущность в Ident: TreatmentPlans (Планы лечения)
Реализация в Битрикс24: Локальное приложение (встраиваемый виджет)
Метод интеграции: REST API + локальное приложение на JavaScript
Размещение: Карточка сделки, вкладка "План лечения"
3.3. Детальная таблица соответствия полей
№	Поле Ident	Тип данных Ident	Поле в приложении Битрикс24	Тип отображения	Обязательность	Примечание
1	ID плана	INT	plan_id	hidden	Обязательное	Скрытое поле для идентификации
2	Название плана	NVARCHAR	plan_name	text	Обязательное	Заголовок плана
3	Пациент (ФИО)	NVARCHAR	-	-	-	Извлекается из связанного контакта сделки
4	Врач (ФИО)	NVARCHAR	doctor_name	text	Обязательное	Отображается в заголовке
5	Этап	NVARCHAR	stage	text	Необязательное	Колонка таблицы
6	Порядок этапа	INT	stage_order	number	Необязательное	Для сортировки
7	Элемент плана	NVARCHAR	element	text	Необязательное	Колонка таблицы
8	Услуга	NVARCHAR	service	text	Обязательное	Колонка таблицы
9	Статус выполнения	VARCHAR	status	badge	Обязательное	Цветной индикатор
10	Цена	DECIMAL	price	currency	Обязательное	Колонка таблицы
11	Скидка	DECIMAL	discount	currency	Необязательное	Колонка таблицы
12	Итого	DECIMAL	total	currency	Обязательное	Колонка таблицы + 
3.4. Правила извлечения ФИО пациента
Источник данных: Контакт (Contact), связанный со сделкой (Deal)
Алгоритм:
Процесс извлечения ФИО пациента выполняется в следующей последовательности:
1.	Получение контекста приложения: Система определяет ID текущей сделки из параметров встроенного приложения Битрикс24
2.	Загрузка данных сделки: Выполняется запрос к API Битрикс24 для получения полной информации о сделке, включая ID связанного контакта
3.	Получение данных контакта: Если контакт привязан к сделке, система запрашивает его данные через API Битрикс24
4.	Формирование ФИО: Из данных контакта извлекаются поля "Фамилия" (LAST_NAME), "Имя" (NAME) и "Отчество" (SECOND_NAME), которые объединяются в полное ФИО через пробел. Пустые значения автоматически исключаются
5.	Альтернативный вариант: Если контакт не привязан к сделке, система извлекает ФИО из названия сделки (TITLE), используя разделитель " - " для отделения ФИО от даты
6.	Загрузка плана лечения: Полученное ФИО используется для поиска соответствующего плана лечения через REST API
Функция извлечения ФИО из названия сделки:
Если контакт недоступен, система анализирует название сделки, которое имеет формат "Фамилия Имя Отчество - ДД.ММ.ГГГГ ЧЧ:ММ". Извлекается часть до разделителя " - " и используется как ФИО пациента.
3.5. Правила расчета итоговых сумм
3.5.1. Сумма по услуге
Формула:
Итого услуги = (Цена × Количество зубов) - Скидка
Пример:
•	Цена: 30 000 руб.
•	Количество зубов: 3
•	Скидка: 0 руб.
•	Итого: 90 000 руб.
3.5.2. Сумма по этапу
Формула:
Итого этап = Σ (Итого услуги)
3.5.3. Общая сумма плана
Формула:
Общая сумма = Σ (Итого этап)
________________________________________
4. ПРАВИЛА ВАЛИДАЦИИ ДАННЫХ
4.1. Валидация обязательных полей
Правило: Все поля, помеченные как "Обязательное", должны содержать непустые значения перед отправкой в Битрикс24.
Обработка нарушений:
•	Запись пропускается
•	Событие фиксируется в журнале с уровнем WARNING
•	Администратор получает уведомление при накоплении >10 ошибок за час
Пример журнала:
[2024-12-30 10:15:23] WARNING: Validation failed for Reception ID 12345
Field 'Телефон' is required but empty.
Reception skipped. Patient: Иванов Иван Иванович
4.2. Валидация форматов данных
4.2.1. Телефон
Правила:
•	Должен содержать ровно 11 цифр после нормализации
•	Должен начинаться с +7
•	Не должен содержать буквы
Валидация:
Система проверяет корректность телефонного номера по следующим критериям:
•	Наличие номера (не пустое значение)
•	После нормализации номер должен содержать ровно 11 цифр
•	Номер должен начинаться с "+7"
•	Номер не должен содержать буквы или недопустимые символы
При обнаружении некорректного формата система фиксирует ошибку с указанием исходного значения номера.
4.2.2. Дата и время
Правила:
•	Дата не должна быть в будущем более чем на 1 год
•	Дата не должна быть в прошлом более чем на 10 лет
•	Время окончания должно быть позже времени начала
Валидация:
Система выполняет проверку корректности дат по следующим правилам:
Проверка диапазона дат:
•	Дата начала не должна быть в будущем более чем на 1 год от текущей даты
•	Дата начала не должна быть в прошлом более чем на 10 лет от текущей даты
•	Время окончания должно быть строго позже времени начала приема
Обработка ошибок: При обнаружении нарушений система формирует сообщение об ошибке с указанием конкретной проблемы:
•	"Дата начала слишком далеко в будущем" - если запись планируется более чем через год
•	"Дата начала слишком далеко в прошлом" - если запись старше 10 лет
•	"Время окончания должно быть позже времени начала" - если логика времени нарушена
4.2.3. Сумма
Правила:
•	Должна быть неотрицательной
•	Не должна превышать 10 000 000 рублей
•	Точность: до 2 знаков после запятой
Валидация:
Система проверяет корректность суммы по следующим критериям:
Допустимый диапазон значений:
•	Сумма не может быть отрицательной (минимум: 0)
•	Сумма не должна превышать 10 000 000 рублей (максимальный лимит)
•	Точность представления: до 2 знаков после запятой
Обработка ошибок:
•	При отрицательной сумме: "Сумма не может быть отрицательной"
•	При превышении лимита: "Сумма превышает допустимый лимит (10 млн руб.)"
Эти ограничения предотвращают ошибки ввода данных и обеспечивают корректность финансовых расчетов.
4.3. Валидация связности данных
Правило: При наличии причины отмены статус должен быть "Отменен"
Логика проверки:
Система проверяет согласованность данных об отмене записи:
1.	Критическая ошибка: Если указана причина отмены, но статус записи не установлен в "Отменен" (C1:LOSE), система фиксирует ошибку с сообщением "Причина отмены указана, но статус не 'Отменен'". Такая запись не будет синхронизирована.
2.	Предупреждение: Если статус установлен в "Отменен" (C1:LOSE), но причина отмены не указана, система выдает предупреждение в журнале, но продолжает синхронизацию. Это не критичная ошибка, так как отмена может быть без детального описания причины.
Такая проверка обеспечивает логическую целостность данных и предотвращает несогласованные состояния записей.
________________________________________
5. ОБРАБОТКА СПЕЦИАЛЬНЫХ СЛУЧАЕВ
5.1. Отсутствие данных о филиале
Ситуация: Не удалось определить филиал через COALESCE
Действия:
1.	Установить значение "Не указан"
2.	Зафиксировать событие в журнале с уровнем WARNING
3.	Отправить данные в Битрикс24
4.	Уведомить администратора при накоплении >5 случаев
Пример журнала:
[2024-12-30 10:20:15] WARNING: Filial not determined for Reception ID 12345
Set to default value 'Не указан'. Patient: Петров Петр
Please check OwnCompanies linkage for this reception.
5.2. Запись без услуг
Ситуация: Запись создана, но заказ не сформирован (услуги отсутствуют)
Действия:
1.	Передать запись с пустым полем UF_CRM_SERVICES
2.	Установить сумму = 0
3.	Зафиксировать событие с уровнем INFO
5.3. Множественные планы лечения
Ситуация: У пациента несколько активных планов лечения
Действия:
1.	Локальное приложение отображает список планов
2.	Пользователь выбирает нужный план из списка
3.	При отсутствии выбора показывается последний созданный план
Реализация:
Локальное приложение обрабатывает ситуацию с несколькими планами следующим образом:
1.	Множественный выбор: Если система находит более одного активного плана лечения для пациента, отображается список всех найденных планов с краткой информацией (название, дата создания, общая сумма)
2.	Выбор пользователя: Пользователь может выбрать нужный план из списка, нажав на соответствующую строку
3.	Отображение выбранного плана: После выбора система загружает и отображает полную детализацию выбранного плана лечения
4.	Поведение по умолчанию: Если пользователь не делает выбор, автоматически отображается последний созданный план (с наиболее поздней датой создания)
5.	Единственный план: Если найден только один активный план, он сразу отображается без дополнительных диалогов выбора
6.	Отсутствие планов: Если планы не найдены, выводится соответствующее информационное сообщение
5.4. План лечения не найден
Ситуация: По ФИО пациента не найдено ни одного активного плана лечения
Действия:
1.	Отобразить сообщение: "План лечения не найден для данного пациента"
2.	Предложить кнопку "Обновить" для повторного поиска
3.	Зафиксировать событие в журнале
________________________________________
6. ЗАКЛЮЧЕНИЕ
Настоящий документ содержит полную спецификацию маппинга данных между системой Ident и CRM Битрикс24. Все правила преобразования, валидации и обработки данных определены с учетом специфики обеих систем и обеспечивают корректную синхронизацию информации между филиалами организации.
Реализация описанных схем маппинга гарантирует:
•	Сохранение целостности данных при передаче между системами
•	Корректное отображение информации в Битрикс24
•	Надежную идентификацию записей из разных филиалов
•	Возможность отслеживания статусов и изменений в реальном времени
