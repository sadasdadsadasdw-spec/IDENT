# Интеграция Ident-Битрикс24

Система интеграции стоматологической информационной системы Ident с облачной CRM Битрикс24

## Описание проекта

Автоматизированная система синхронизации данных о записях пациентов и планах лечения из локальных баз данных Ident в единую облачную CRM Битрикс24 для обеспечения централизованного контроля и управления бизнес-процессами пяти филиалов стоматологической организации.

### Ключевые возможности

- **Автоматическая синхронизация записей** - передача данных о записях пациентов каждые 2 минуты
- **Централизованное управление** - единая точка доступа к данным из всех филиалов
- **Отслеживание планов лечения** - визуализация планов через локальное приложение в Битрикс24
- **Управление воронкой продаж** - автоматическое определение стадий сделок
- **Надежность и отказоустойчивость** - механизм очередей и повторных попыток

## Архитектура решения

### Компоненты

1. **Интеграционный модуль** (Python 3.10+)
   - Модуль извлечения данных из БД Ident
   - Модуль преобразования и валидации данных
   - Модуль отправки через webhook API
   - Модуль логирования и мониторинга
   - Модуль управления очередью

2. **Локальное приложение Битрикс24** (HTML5/JavaScript)
   - Отображение планов лечения в карточке сделки
   - Визуализация этапов и услуг
   - Расчет итоговых сумм

### Топология

```
┌─────────────────┐
│   Филиал 1-5    │
│                 │
│  ┌──────────┐   │      HTTPS        ┌──────────────┐
│  │  Ident   │◄──┼─────────────────► │  Битрикс24   │
│  │   БД     │   │    webhook        │     CRM      │
│  └──────────┘   │                   └──────────────┘
│       ▲         │
│       │         │
│  ┌────┴─────┐   │
│  │Интеграц. │   │
│  │  модуль  │   │
│  └──────────┘   │
└─────────────────┘
```

## Технологический стек

### Backend (Интеграционный модуль)
- Python 3.10+
- pyodbc - работа с SQL Server
- requests - HTTP-запросы
- schedule - планировщик задач
- PyInstaller - упаковка в исполняемый файл

### Database
- Microsoft SQL Server (до версии 2016)
- ODBC-соединение (read-only)

### CRM
- Битрикс24 REST API
- Входящий webhook
- HTTPS протокол

### Frontend (Локальное приложение)
- HTML5, JavaScript (ES6+), CSS3
- BX24.js SDK
- Размещение: iframe в карточке сделки

## Синхронизируемые данные

### 1. Записи на приём (Receptions → Deal)

**Состав данных (17 основных полей):**
- Идентификационные данные пациента (ФИО, телефон, номер карты)
- Данные записи (дата/время начала и окончания, филиал, кабинет)
- Данные врача (ФИО, специальность)
- Услуги и финансы (перечень услуг, сумма)
- Статусы и метки времени
- Дополнительная информация (комментарии, причина отмены)

**Периодичность:** Каждые 2 минуты
**Объем:** 10-50 записей за цикл (один филиал)

### 2. План лечения (TreatmentPlans → Local App)

**Состав данных (12 полей):**
- Информация о плане (ID, название, дата создания)
- Пациент и врач (ФИО)
- Структура плана (этапы, элементы, услуги)
- Финансы (цена, скидка, итого)
- Статус выполнения

**Периодичность:** По запросу (on-demand)
**Объем:** 1 план за запрос

## Логика работы

### Процесс синхронизации записей

1. **Извлечение данных** - SQL-запрос к БД Ident с инкрементальной выборкой
2. **Преобразование** - валидация, нормализация, маппинг полей
3. **Поиск клиента** - поиск по телефону в Битрикс24
   - Не найден → создание контакта и сделки
   - Найден лид → конвертация в контакт и сделку
   - Найден контакт → поиск сделки по ID или создание новой
4. **Отправка данных** - JSON-запрос через webhook API
5. **Обработка ошибок** - сохранение в очередь при неудаче

### Стадии воронки продаж

```
CONSULTATION_SCHEDULED → CONSULTATION_DONE → PLAN_PRESENTATION →
PREPAYMENT_RECEIVED → TREATMENT → WON/LOSE
```

**Автоматические стадии:**
- Запись на консультацию
- Консультация проведена
- Лечение
- Успешно / Не успешно

**Ручные стадии (защищены от автоизменения):**
- Презентация плана лечения
- Получена предоплата
- Лист ожидания

## Функциональные требования

### Синхронизация
- ✓ Автоматическая односторонняя синхронизация (Ident → Битрикс24)
- ✓ Инкрементальная синхронизация (только новые/измененные)
- ✓ Идентификация филиала (включая 2 филиала на 1 БД)
- ✓ Создание новых контактов
- ✓ Конвертация лидов в контакты и сделки
- ✓ Обновление существующих сделок
- ✓ Определение стадии воронки по алгоритму
- ✓ Защита ручных стадий от автоизменения

### Обработка данных
- ✓ Валидация обязательных полей
- ✓ Нормализация телефонов (+7XXXXXXXXXX)
- ✓ Преобразование дат (ISO 8601 с временной зоной)
- ✓ Уникальный идентификатор F[N]_[ID]
- ✓ Агрегация услуг (через запятую, лимит 3000 символов)
- ✓ Расчет суммы с учетом скидок

### Надежность
- ✓ Автоперезапуск после критических ошибок (в течение 5 минут)
- ✓ Повторные попытки с экспоненциальной задержкой (30с, 1м, 5м)
- ✓ Детальное журналирование с ротацией (30 дней)
- ✓ Уведомления при превышении порога ошибок (>10% за час)

### Производительность
- ✓ Обработка записи: ≤ 2 секунды
- ✓ Цикл синхронизации (50 записей): ≤ 2 минуты
- ✓ CPU в режиме ожидания: ≤ 2%
- ✓ RAM: ≤ 200 МБ
- ✓ Время запуска: ≤ 10 секунд

## Нефункциональные требования

### Надежность
- **Доступность:** 99% (простой ≤ 7 часов/месяц)
- **Восстановление:** ≤ 5 минут после сбоя
- **Очередь:** до 1000 неотправленных записей

### Безопасность
- HTTPS (TLS 1.2+) для всех передач
- Шифрование webhook-токена
- Защищенное хранилище учетных данных БД
- Маскирование ПД в журналах
- Ограничение прав доступа

### Масштабируемость
- Поддержка до 10 филиалов без изменения архитектуры
- Увеличение объемов данных в 2 раза без деградации
- Добавление новых синхронизируемых сущностей

## Установка и развертывание

### Требования к системе
- Windows 10/11 или Windows Server 2016+
- Python 3.10+
- Стабильное интернет-соединение (≥ 1 Мбит/с)
- Доступ к БД Ident (SQL Server)
- Webhook-токен Битрикс24

### Быстрый старт

```bash
# 1. Клонирование репозитория
git clone <repository-url>
cd IDENT

# 2. Установка зависимостей
pip install -r requirements.txt

# 3. Настройка конфигурации
cp config.example.ini config.ini
# Отредактировать config.ini с параметрами БД и webhook

# 4. Запуск интеграционного модуля
python main.py

# 5. Установка как службы Windows
python install_service.py
```

### Конфигурация

Основные параметры в `config.ini`:

```ini
[Database]
server = localhost
database = IdentDB
username = ident_user
password = encrypted_password

[Bitrix24]
webhook_url = https://your-portal.bitrix24.ru/rest/...
token = encrypted_token

[Sync]
interval_minutes = 2
batch_size = 50

[Logging]
level = INFO
rotation_days = 30
```

## Мониторинг

### Веб-интерфейс
Доступен на `http://localhost:8080/` после запуска интеграционного модуля.

**Доступная информация:**
- Статус синхронизации
- Количество обработанных записей
- Процент успешных операций
- Последние ошибки
- Размер очереди неотправленных данных

### Журналы

Расположение: `logs/integration_log_YYYY-MM-DD.txt`

**Уровни логирования:**
- INFO - обычные операции
- WARNING - предупреждения (филиал не определен, валидация)
- ERROR - ошибки (сеть, API, БД)
- CRITICAL - критические ошибки (требуют вмешательства)

## Тестирование

### Запуск тестов

```bash
# Модульные тесты
pytest tests/unit/

# Интеграционные тесты
pytest tests/integration/

# Нагрузочные тесты
pytest tests/load/

# Все тесты с покрытием
pytest --cov=src tests/
```

---

*Версия документа: 1.0*
*Дата последнего обновления: 2026-01-21*
