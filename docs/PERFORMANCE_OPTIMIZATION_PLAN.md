# –ê–ù–ê–õ–ò–ó –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò –ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò –ü–†–û–ï–ö–¢–ê IDENT ‚Üí BITRIX24

## üìä –¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:
- **CPU**: ~10% (–ø–∏–∫–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞)
- **RAM**: 200-300 MB
- **–ß–∞—Å—Ç–æ—Ç–∞**: –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
- **Batch size**: 100 –∑–∞–ø–∏—Å–µ–π

---

## üîç –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É)

### üî¥ –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

#### 1. –î–ï–ö–ê–†–¢–û–í–û –ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï –í SQL –ó–ê–ü–†–û–°–ê–• ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û
**–§–∞–π–ª**: `src/database/ident_connector_v2.py`
**–ú–µ—Ç–æ–¥—ã**: `get_treatment_plans_*` (3 –º–µ—Ç–æ–¥–∞)
**–°—Ç—Ä–æ–∫–∏**: 534-617, 661-741, 785-866

**–ü—Ä–æ–±–ª–µ–º–∞:**
```sql
-- 14 LEFT JOIN —Å–æ–∑–¥–∞—é—Ç –¥–µ–∫–∞—Ä—Ç–æ–≤–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ:
FROM TreatmentPlans tp
LEFT JOIN Patients pat
LEFT JOIN Persons p
LEFT JOIN Staffs s_plan
LEFT JOIN Persons ps_plan
LEFT JOIN Items i_plan
LEFT JOIN ProfessionNames pn_plan
LEFT JOIN TreatmentPlanElementRelations tper
LEFT JOIN TreatmentPlanStages tps
LEFT JOIN TreatmentPlanElements tpe
LEFT JOIN ServiceItemPrices sip
LEFT JOIN ServiceItems si
LEFT JOIN ServiceItemContents sic
LEFT JOIN ServiceFolders sf
LEFT JOIN ServiceCategories sc
LEFT JOIN OrderServiceRelation osr
LEFT JOIN Orders o
LEFT JOIN Receptions r
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü–ª–∞–Ω —Å 50 —É—Å–ª—É–≥–∞–º–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 50+ —Å—Ç—Ä–æ–∫ —Å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- –ï—Å–ª–∏ —É –ø–∞—Ü–∏–µ–Ω—Ç–∞ 3 –ø–ª–∞–Ω–∞ - –¥–∞–Ω–Ω—ã–µ —É—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è
- –ü–µ—Ä–µ–¥–∞—á–∞ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–µ—Ç–∏: ~300KB –≤–º–µ—Å—Ç–æ ~50KB
- –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ SQL Server —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è

**–û—Ü–µ–Ω–∫–∞ impact**: **–°–Ω–∏–∂–µ–Ω–∏–µ CPU –Ω–∞ 30-40%, RAM –Ω–∞ 40-50%**

---

#### 2. –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–´–ï OR –í WHERE –ë–ï–ó –ò–ù–î–ï–ö–°–ê ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û
**–§–∞–π–ª**: `src/database/ident_connector_v2.py`
**–ú–µ—Ç–æ–¥**: `get_receptions()`
**–°—Ç—Ä–æ–∫–∏**: 463-472

**–ü—Ä–æ–±–ª–µ–º–∞:**
```sql
WHERE (
    r.DateTimeAdded > ? OR
    r.DateTimeChanged > ? OR
    r.PatientAppeared > ? OR
    r.ReceptionStarted > ? OR
    r.ReceptionEnded > ? OR
    r.ReceptionCanceled > ?
)
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- SQL Server –Ω–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ
- –í—ã–Ω—É–∂–¥–µ–Ω –¥–µ–ª–∞—Ç—å FULL TABLE SCAN –≤–º–µ—Å—Ç–æ INDEX SEEK
- –ù–∞ 10000+ –∑–∞–ø–∏—Å–µ–π —ç—Ç–æ –∑–∞–º–µ–¥–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ 5-10 —Ä–∞–∑

**–û—Ü–µ–Ω–∫–∞ impact**: **–°–Ω–∏–∂–µ–Ω–∏–µ CPU –Ω–∞ 20-30%**

---

#### 3. –û–¢–°–£–¢–°–¢–í–ò–ï –ö–†–ò–¢–ò–ß–ù–´–• –ò–ù–î–ï–ö–°–û–í ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û
**–§–∞–π–ª**: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö IDENT

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–æ–ª—è—Ö

**–û—Ü–µ–Ω–∫–∞ impact**: **–°–Ω–∏–∂–µ–Ω–∏–µ CPU –Ω–∞ 40-50%**

---

### üü† –í–´–°–û–ö–û–ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

#### 4. STUFF+FOR XML –í OUTER APPLY
**–§–∞–π–ª**: `src/database/ident_connector_v2.py`
**–ú–µ—Ç–æ–¥**: `get_receptions()`
**–°—Ç—Ä–æ–∫–∏**: 446-461

**–ü—Ä–æ–±–ª–µ–º–∞:**
```sql
OUTER APPLY (
    SELECT STUFF((
        SELECT ', ' + si_inner.Name
        FROM OrderServiceRelation ...
        FOR XML PATH(''), TYPE
    ).value('.', 'NVARCHAR(MAX)'), 1, 2, '')
)
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- FOR XML –º–µ–¥–ª–µ–Ω–Ω—ã–π –Ω–∞ SQL Server 2012-2016
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è –ö–ê–ñ–î–û–ô –∑–∞–ø–∏—Å–∏
- –°–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ XML —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ –ø–∞–º—è—Ç–∏

**–û—Ü–µ–Ω–∫–∞ impact**: **–°–Ω–∏–∂–µ–Ω–∏–µ CPU –Ω–∞ 10-15%** (–µ—Å–ª–∏ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ STRING_AGG –≤ SQL 2017+)

---

#### 5. –ò–ó–ë–´–¢–û–ß–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
**–§–∞–π–ª—ã**: –í—Å–µ —Ñ–∞–π–ª—ã —Å `logger.debug()`, `logger.info()`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
logger.debug(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø–∏—Å–∏ {reception_id}")  # –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è 100 —Ä–∞–∑ –∑–∞ —Ü–∏–∫–ª
logger.info(f"–ù–∞–π–¥–µ–Ω –∫–æ–Ω—Ç–∞–∫—Ç ID={contact_id}")    # –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–∞—Å—Ç–æ
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ logger —Å–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä–æ–∫—É (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª - I/O –æ–ø–µ—Ä–∞—Ü–∏—è
- logger –≤—ã–∑—ã–≤–∞–µ—Ç datetime.now() –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ

**–û—Ü–µ–Ω–∫–∞ impact**: **–°–Ω–∏–∂–µ–Ω–∏–µ CPU –Ω–∞ 5-10%, I/O –Ω–∞ 30%**

---

#### 6. –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –°–õ–û–í–ê–†–ï–ô –í –¶–ò–ö–õ–ê–•
**–§–∞–π–ª**: `src/transformer/data_transformer.py`
**–ú–µ—Ç–æ–¥**: `transform_batch()`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
for reception in receptions:
    # –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π —Å–ª–æ–≤–∞—Ä—å –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
    transformed = self.transform_reception(reception)
    successful.append(transformed)  # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –î–ª—è 100 –∑–∞–ø–∏—Å–µ–π —Å–æ–∑–¥–∞–µ—Ç—Å—è 100+ —Å–ª–æ–≤–∞—Ä–µ–π –≤ –ø–∞–º—è—Ç–∏
- Garbage collector —Ä–∞–±–æ—Ç–∞–µ—Ç —á–∞—â–µ
- –§—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è –ø–∞–º—è—Ç–∏

**–û—Ü–µ–Ω–∫–∞ impact**: **–°–Ω–∏–∂–µ–Ω–∏–µ RAM –Ω–∞ 10-15%, CPU –Ω–∞ 5%**

---

### üü° –°–†–ï–î–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´

#### 7. –ú–ê–õ–ï–ù–¨–ö–ò–ô BATCH SIZE (fetchmany)
**–§–∞–π–ª**: `src/database/ident_connector_v2.py`
**–í—Å–µ –º–µ—Ç–æ–¥—ã –ë–î**

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
rows = cursor.fetchmany(100)  # –°–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π —Ä–∞–∑–º–µ—Ä
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –î–ª—è 1000 –∑–∞–ø–∏—Å–µ–π = 10 —Ü–∏–∫–ª–æ–≤ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –∫—É—Ä—Å–æ—Ä—É
- –õ–∏—à–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
- –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 500-1000

**–û—Ü–µ–Ω–∫–∞ impact**: **–°–Ω–∏–∂–µ–Ω–∏–µ CPU –Ω–∞ 3-5%**

---

#### 8. –ù–ï–≠–§–§–ï–ö–¢–ò–í–ù–û–ï –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –°–¢–†–û–ö
**–§–∞–π–ª—ã**: –í—Å–µ —Ñ–∞–π–ª—ã

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
f"—Å—Ç—Ä–æ–∫–∞ {–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è}"  # f-strings —Å–æ–∑–¥–∞—é—Ç –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –∫–∞–∂–¥—ã–π —Ä–∞–∑
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –î–ª—è 100 –∑–∞–ø–∏—Å–µ–π —Å–æ–∑–¥–∞–µ—Ç—Å—è 500+ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
- GC —Ä–∞–±–æ—Ç–∞–µ—Ç —á–∞—â–µ

**–û—Ü–µ–Ω–∫–∞ impact**: **–°–Ω–∏–∂–µ–Ω–∏–µ RAM –Ω–∞ 5-8%**

---

#### 9. –û–¢–°–£–¢–°–¢–í–ò–ï –ë–ê–¢–ß–ò–ù–ì–ê –î–õ–Ø BITRIX24 API
**–§–∞–π–ª**: `src/bitrix/api_client.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é —Å–¥–µ–ª–∫—É –æ—Ç–¥–µ–ª—å–Ω–æ:
for deal_id in deal_ids:
    self.update_deal(deal_id, data)  # 100 HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- 100 HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–º–µ—Å—Ç–æ 1 batch –∑–∞–ø—Ä–æ—Å–∞
- Bitrix24 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `batch` API

**–û—Ü–µ–Ω–∫–∞ impact**: **–°–Ω–∏–∂–µ–Ω–∏–µ CPU –Ω–∞ 10-15%, Network –Ω–∞ 80%**

---

#### 10. –û–¢–°–£–¢–°–¢–í–ò–ï LAZY LOADING
**–§–∞–π–ª**: `main.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É:
receptions = self.db.get_receptions(batch_size=100)
# –ó–∞—Ç–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –í–°–ï:
for reception in receptions:
    ...
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- 100 –∑–∞–ø–∏—Å–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ RAM –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ú–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ –æ–¥–Ω–æ–π (generator pattern)

**–û—Ü–µ–Ω–∫–∞ impact**: **–°–Ω–∏–∂–µ–Ω–∏–µ RAM –Ω–∞ 15-20%**

---

## ‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)

### üî¥ –ö–†–ò–¢–ò–ß–ù–´–ï (–°–î–ï–õ–ê–¢–¨ –°–ï–ô–ß–ê–°)

#### –û–ü–¢-1: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –≤ –ë–î IDENT ‚ö†Ô∏è –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –≠–§–§–ï–ö–¢

**SQL —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è DBA:**
```sql
-- 1. –ò–Ω–¥–µ–∫—Å –Ω–∞ Receptions.DateTimeChanged (–≥–ª–∞–≤–Ω—ã–π –¥–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
CREATE INDEX IX_Receptions_DateTimeChanged
ON Receptions(DateTimeChanged DESC, ID)
INCLUDE (DateTimeAdded, PlanStart, PlanEnd);

-- 2. –ò–Ω–¥–µ–∫—Å –Ω–∞ Patients.CardNumber (–¥–ª—è –ø–ª–∞–Ω–æ–≤ –ª–µ—á–µ–Ω–∏—è)
CREATE UNIQUE INDEX IX_Patients_CardNumber
ON Patients(CardNumber)
WHERE CardNumber IS NOT NULL;

-- 3. –ò–Ω–¥–µ–∫—Å –Ω–∞ Persons –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –§–ò–û
CREATE INDEX IX_Persons_FullName
ON Persons(Surname, Name, Patronymic)
INCLUDE (ID, MobilePhone);

-- 4. –ò–Ω–¥–µ–∫—Å –Ω–∞ TreatmentPlans –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö
CREATE INDEX IX_TreatmentPlans_Patient
ON TreatmentPlans(ID_Patients, IsActive, DateTimeCreated DESC)
INCLUDE (ID, Name);

-- 5. –ò–Ω–¥–µ–∫—Å –Ω–∞ OrderServiceRelation –¥–ª—è OUTER APPLY
CREATE INDEX IX_OrderServiceRelation_Order
ON OrderServiceRelation(ID_Orders)
INCLUDE (ID_ServicePrices, ID_TreatmentPlanElementRelations);

-- 6. –ò–Ω–¥–µ–∫—Å –Ω–∞ ServiceItemPrices
CREATE INDEX IX_ServiceItemPrices_Item
ON ServiceItemPrices(ID_ServiceItems)
INCLUDE (ID, Price);
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:**
- ‚¨áÔ∏è CPU: -40-50%
- ‚¨áÔ∏è RAM: -30%
- ‚¨áÔ∏è –í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞: -60-70%

---

#### –û–ü–¢-2: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å WHERE —É—Å–ª–æ–≤–∏–µ –≤ get_receptions()

**–§–∞–π–ª**: `src/database/ident_connector_v2.py`
**–ú–µ—Ç–æ–¥**: `get_receptions()`

**–î–æ:**
```python
WHERE (
    r.DateTimeAdded > ? OR
    r.DateTimeChanged > ? OR
    ...  # 6 OR —É—Å–ª–æ–≤–∏–π
)
```

**–ü–æ—Å–ª–µ:**
```python
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ DateTimeChanged (—Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –ø–æ–ª–µ)
WHERE r.DateTimeChanged > ?

# –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GREATEST (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –≤—Å–µ –ø–æ–ª—è)
WHERE GREATEST(
    COALESCE(r.DateTimeChanged, '1900-01-01'),
    COALESCE(r.DateTimeAdded, '1900-01-01'),
    COALESCE(r.PatientAppeared, '1900-01-01'),
    COALESCE(r.ReceptionStarted, '1900-01-01'),
    COALESCE(r.ReceptionEnded, '1900-01-01'),
    COALESCE(r.ReceptionCanceled, '1900-01-01')
) > ?
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:**
- ‚¨áÔ∏è CPU: -20-30%
- ‚¨áÔ∏è –í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞: -40-50%

---

#### –û–ü–¢-3: –†–∞–∑–±–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã TreatmentPlan –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–µ–π

**–§–∞–π–ª**: `src/database/ident_connector_v2.py`
**–ú–µ—Ç–æ–¥—ã**: `get_treatment_plans_by_card_number()`, `get_treatment_plan_by_id()`, `get_treatment_plans_by_patient_name()`

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:** –í–º–µ—Å—Ç–æ 1 –æ–≥—Ä–æ–º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Å 14 LEFT JOIN ‚Üí 2-3 –º–∞–ª–µ–Ω—å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–∞

**–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏:** —Å–º. —Ñ–∞–π–ª `optimizations/treatment_plan_query_optimization.md`

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:**
- ‚¨áÔ∏è CPU: -30-40%
- ‚¨áÔ∏è RAM: -40-50%
- ‚¨áÔ∏è –°–µ—Ç–µ–≤–æ–π —Ç—Ä–∞—Ñ–∏–∫: -70%

---

### üü† –í–´–°–û–ö–û–ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï (–°–î–ï–õ–ê–¢–¨ –ù–ê –≠–¢–û–ô –ù–ï–î–ï–õ–ï)

#### –û–ü–¢-4: –°–Ω–∏–∑–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è production

**–§–∞–π–ª**: `config.ini`

**–î–æ:**
```ini
[logging]
level = DEBUG  # –∏–ª–∏ INFO
```

**–ü–æ—Å–ª–µ:**
```ini
[logging]
level = WARNING  # —Ç–æ–ª—å–∫–æ warnings –∏ errors
```

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Å–ª–æ–≤–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
```python
# –î–æ:
logger.debug(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø–∏—Å–∏ {reception_id}")

# –ü–æ—Å–ª–µ:
if logger.isEnabledFor(logging.DEBUG):
    logger.debug(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø–∏—Å–∏ {reception_id}")
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:**
- ‚¨áÔ∏è CPU: -5-10%
- ‚¨áÔ∏è I/O: -80%
- ‚¨áÔ∏è –†–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤: -90%

---

#### –û–ü–¢-5: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –≤–º–µ—Å—Ç–æ —Å–ø–∏—Å–∫–æ–≤

**–§–∞–π–ª**: `src/database/ident_connector_v2.py`
**–í—Å–µ –º–µ—Ç–æ–¥—ã —Å `fetchmany()`**

**–î–æ:**
```python
results = []
while True:
    rows = cursor.fetchmany(100)
    if not rows:
        break
    results.extend(dict(zip(columns, row)) for row in rows)
return results  # –í–µ—Å—å —Å–ø–∏—Å–æ–∫ –≤ –ø–∞–º—è—Ç–∏
```

**–ü–æ—Å–ª–µ:**
```python
def _fetch_generator(cursor, columns):
    """–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–ª—è –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏"""
    while True:
        rows = cursor.fetchmany(500)  # –£–≤–µ–ª–∏—á–µ–Ω —Ä–∞–∑–º–µ—Ä
        if not rows:
            break
        for row in rows:
            yield dict(zip(columns, row))

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
for reception in self.db.get_receptions_generator():
    self.process(reception)  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ –æ–¥–Ω–æ–π
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:**
- ‚¨áÔ∏è RAM: -40-60%
- ‚¨áÔ∏è GC —Ä–∞–±–æ—Ç–∞: -50%

---

#### –û–ü–¢-6: –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä fetchmany

**–§–∞–π–ª**: `src/database/ident_connector_v2.py`

**–î–æ:**
```python
rows = cursor.fetchmany(100)
```

**–ü–æ—Å–ª–µ:**
```python
rows = cursor.fetchmany(500)  # –ò–ª–∏ –¥–∞–∂–µ 1000
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:**
- ‚¨áÔ∏è CPU: -5%
- ‚¨áÔ∏è –í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞: -10-15%

---

### üü° –°–†–ï–î–ù–ò–ï (–°–î–ï–õ–ê–¢–¨ –í –¢–ï–ß–ï–ù–ò–ï –ú–ï–°–Ø–¶–ê)

#### –û–ü–¢-7: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å batch API –¥–ª—è Bitrix24

**–§–∞–π–ª**: `src/bitrix/api_client.py`

**–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥:**
```python
def batch_update_deals(self, updates: List[Tuple[int, Dict]]) -> List[bool]:
    """
    Batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫ —á–µ—Ä–µ–∑ Bitrix24 batch API

    Args:
        updates: [(deal_id, update_data), ...]

    Returns:
        [True, False, True, ...] - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    """
    # Bitrix24 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ 50 –∫–æ–º–∞–Ω–¥ –≤ batch
    cmd = {}
    for i, (deal_id, data) in enumerate(updates[:50]):
        cmd[f"deal_{i}"] = {
            "method": "crm.deal.update",
            "params": {"id": deal_id, "fields": data}
        }

    result = self._make_request("batch", {"cmd": cmd})
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:**
- ‚¨áÔ∏è Network: -80%
- ‚¨áÔ∏è CPU: -10-15%

---

#### –û–ü–¢-8: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤

**–§–∞–π–ª**: `main.py`

**–ò–¥–µ—è:** –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å mapping phone ‚Üí contact_id –≤ –ø–∞–º—è—Ç–∏

```python
class ContactCache:
    def __init__(self, ttl=3600):
        self.cache = {}  # {phone: contact_id}
        self.ttl = ttl

    def get(self, phone):
        entry = self.cache.get(phone)
        if entry and time.time() - entry['time'] < self.ttl:
            return entry['id']
        return None

    def set(self, phone, contact_id):
        self.cache[phone] = {'id': contact_id, 'time': time.time()}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:**
- ‚¨áÔ∏è API –∑–∞–ø—Ä–æ—Å—ã: -30-50%
- ‚¨áÔ∏è CPU: -5-10%

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê –≠–§–§–ï–ö–¢–ê

| –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | CPU | RAM | Network | I/O | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|-------------|-----|-----|---------|-----|-----------|-----------|
| –û–ü–¢-1: –ò–Ω–¥–µ–∫—Å—ã –ë–î | -40% | -30% | - | -50% | ‚≠ê –õ–µ–≥–∫–æ | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ |
| –û–ü–¢-2: WHERE –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | -25% | - | - | -40% | ‚≠ê –õ–µ–≥–∫–æ | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ |
| –û–ü–¢-3: –†–∞–∑–±–∏—Ç—å TreatmentPlan | -35% | -45% | -70% | - | ‚≠ê‚≠ê‚≠ê –°–ª–æ–∂–Ω–æ | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ |
| –û–ü–¢-4: –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–æ–≤ | -8% | - | - | -80% | ‚≠ê –õ–µ–≥–∫–æ | üü† –í—ã—Å–æ–∫–æ |
| –û–ü–¢-5: –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã | - | -50% | - | - | ‚≠ê‚≠ê –°—Ä–µ–¥–Ω–µ | üü† –í—ã—Å–æ–∫–æ |
| –û–ü–¢-6: fetchmany size | -5% | - | - | -10% | ‚≠ê –õ–µ–≥–∫–æ | üü† –í—ã—Å–æ–∫–æ |
| –û–ü–¢-7: Batch API | -12% | - | -80% | - | ‚≠ê‚≠ê –°—Ä–µ–¥–Ω–µ | üü° –°—Ä–µ–¥–Ω–µ |
| –û–ü–¢-8: –ö—ç—à –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ | -8% | +5MB | -40% | - | ‚≠ê‚≠ê –°—Ä–µ–¥–Ω–µ | üü° –°—Ä–µ–¥–Ω–µ |

**–ò–¢–û–ì–û –ø–æ—Å–ª–µ –≤—Å–µ—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:**
- üéØ **CPU: —Å 10% –¥–æ 3-4%** (—Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 60-70%)
- üéØ **RAM: —Å 250MB –¥–æ 120-150MB** (—Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 40-50%)
- üéØ **Network: -70-80%** (–º–µ–Ω—å—à–µ —Ç—Ä–∞—Ñ–∏–∫–∞ –∫ Bitrix24)
- üéØ **I/O: -60-70%** (–º–µ–Ω—å—à–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

---

## üöÄ –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### –§–∞–∑–∞ 1: –ë—ã—Å—Ç—Ä—ã–µ –ø–æ–±–µ–¥—ã (1-2 —á–∞—Å–∞)
1. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –≤ –ë–î IDENT (–û–ü–¢-1) - **DBA**
2. –ò–∑–º–µ–Ω–∏—Ç—å level=WARNING –≤ config.ini (–û–ü–¢-4)
3. –£–≤–µ–ª–∏—á–∏—Ç—å fetchmany –¥–æ 500 (–û–ü–¢-6)

**–≠—Ñ—Ñ–µ–∫—Ç:** CPU -50%, I/O -80%

### –§–∞–∑–∞ 2: –°—Ä–µ–¥–Ω—è—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å (1-2 –¥–Ω—è)
1. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å WHERE –≤ get_receptions() (–û–ü–¢-2)
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã (–û–ü–¢-5)

**–≠—Ñ—Ñ–µ–∫—Ç:** CPU -25%, RAM -50%

### –§–∞–∑–∞ 3: –°–ª–æ–∂–Ω—ã–µ (1 –Ω–µ–¥–µ–ª—è)
1. –†–∞–∑–±–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã TreatmentPlan (–û–ü–¢-3)
2. Batch API –¥–ª—è Bitrix24 (–û–ü–¢-7)

**–≠—Ñ—Ñ–µ–∫—Ç:** CPU -35%, Network -75%

---

## üìù –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ main.py:
import psutil
import time

class PerformanceMonitor:
    def __init__(self):
        self.process = psutil.Process()

    def get_stats(self):
        return {
            'cpu_percent': self.process.cpu_percent(interval=1),
            'memory_mb': self.process.memory_info().rss / 1024 / 1024,
            'threads': self.process.num_threads()
        }

# –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É
monitor = PerformanceMonitor()
stats = monitor.get_stats()
logger.info(f"Performance: CPU={stats['cpu_percent']}%, RAM={stats['memory_mb']:.0f}MB")
```

### –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º:
python -m cProfile -o output.prof main.py

# –ê–Ω–∞–ª–∏–∑:
python -m pstats output.prof
> sort cumtime
> stats 20
```

---

## ‚ö†Ô∏è –†–ò–°–ö–ò –ò –ü–†–ï–î–û–°–¢–ï–†–ï–ñ–ï–ù–ò–Ø

1. **–ò–Ω–¥–µ–∫—Å—ã –∑–∞–º–µ–¥–ª—è—Ç INSERT/UPDATE** - –Ω–æ –¥–ª—è read-heavy —Å–∏—Å—Ç–µ–º—ã —ç—Ç–æ OK
2. **–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã —É—Å–ª–æ–∂–Ω—è—Ç debug** - –Ω–µ–ª—å–∑—è –ø—Ä–æ—Å—Ç–æ print(results)
3. **Batch API —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏** - –Ω—É–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
4. **–†–∞–∑–±–∏–µ–Ω–∏–µ TreatmentPlan** - —Å–∞–º–æ–µ —Å–ª–æ–∂–Ω–æ–µ, —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏

---

**–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω**: 2026-01-23
**–í–µ—Ä—Å–∏—è**: 1.0
