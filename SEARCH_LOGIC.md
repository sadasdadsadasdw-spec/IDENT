# Логика поиска и синхронизации IDENT → Bitrix24

## Оглавление
- [Обзор](#обзор)
- [Основной алгоритм](#основной-алгоритм)
- [Детальное описание этапов](#детальное-описание-этапов)
- [Сценарии использования](#сценарии-использования)
- [Особые случаи](#особые-случаи)

---

## Обзор

Интеграция синхронизирует записи на прием из БД IDENT в сделки Bitrix24. Каждая запись имеет уникальный идентификатор формата `F{filial_id}_{reception_id}` (например, `F1_12345`).

**Ключевые принципы:**
- Один человек = один контакт (даже если у семьи один телефон)
- Закрытые сделки (Успешно/Неуспешно) НЕ переоткрываются
- Автоматическая привязка к сделкам без IDENT ID
- Защита данных в определенных стадиях воронки

---

## Основной алгоритм

Метод: `IdentBitrix24Sync.sync_reception_to_bitrix24()`
Файл: `main.py:254`

```
┌─────────────────────────────────────────────────────────────┐
│ 1. Поиск сделки по IDENT ID                                 │
│    └─ Найдена и открыта? → Обновить                         │
│    └─ Найдена и закрыта? → Игнорировать, перейти к шагу 2   │
│    └─ Не найдена? → Перейти к шагу 2                        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. Поиск/создание контакта (с поддержкой семей)             │
│    └─ Поиск по телефону + ТОЧНОЕ совпадение ФИО             │
│    └─ Найден? → Использовать                                │
│    └─ Не найден? → Создать новый контакт                    │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. Поиск сделок БЕЗ IDENT ID для контакта                   │
│    └─ Найдено 0 → Перейти к шагу 4                          │
│    └─ Найдена 1 → Автопривязка (добавить IDENT ID)          │
│    └─ Найдено >1 → Привязать к новейшей + логировать warning│
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. Создание новой сделки (если не было автопривязки)        │
│    └─ Создать сделку с IDENT ID и контактом                 │
└─────────────────────────────────────────────────────────────┘
```

---

## Детальное описание этапов

### ШАГ 1: Поиск сделки по IDENT ID

**Метод:** `Bitrix24APIClient.find_deal_by_ident_id(unique_id)`
**Файл:** `src/bitrix/api_client.py:578`

**Действия:**
```python
1. API запрос: crm.deal.list
   - Фильтр: UF_CRM_1769072841035 = unique_id (например, "F1_12345")
   - Поля: ID, STAGE_ID, CONTACT_ID, TITLE, UF_CRM_1769072841035

2. Анализ результата:
   ├─ Сделка не найдена
   │  └─ Вернуть None → Перейти к шагу 2
   │
   ├─ Сделка найдена и стадия НЕ финальная (не WON, не LOSE)
   │  ├─ Стадия защищенная? (PREPAYMENT_RECEIVED, TREATMENT)
   │  │  └─ Обновить ВСЕ поля КРОМЕ stage_id
   │  └─ Стадия обычная?
   │     └─ Обновить ВСЕ поля включая stage_id
   │
   └─ Сделка найдена и стадия ФИНАЛЬНАЯ (WON или LOSE)
      └─ Логировать: "IGNORE: Сделка {id} уже закрыта"
      └─ Игнорировать эту сделку → Перейти к шагу 2
```

**Пример лога:**
```
IGNORE: Сделка 12345 с IDENT ID F1_67890 уже закрыта (стадия 'C1:WON').
Игнорируем и создаем новую сделку.
```

**Важно:**
- Закрытые сделки НЕ переоткрываются
- Для закрытой сделки создается новая сделка с тем же IDENT ID

---

### ШАГ 2: Поиск/создание контакта

**Метод:** `IdentBitrix24Sync._find_or_create_contact()`
**Файл:** `main.py:386`

**2.1. Точный поиск по телефону + ФИО**

**Метод:** `Bitrix24APIClient.find_contact_by_phone_and_name()`
**Файл:** `src/bitrix/api_client.py:256`

```python
1. API запрос: crm.contact.list
   - Фильтр: PHONE = "+79991234567"
   - Поля: ID, NAME, LAST_NAME, SECOND_NAME, PHONE

2. Получаем ВСЕ контакты с этим телефоном

3. Поиск ТОЧНОГО совпадения:
   ├─ Сравнение (регистронезависимое):
   │  - name.lower() == NAME.lower()
   │  - last_name.lower() == LAST_NAME.lower()
   │  - second_name.lower() == SECOND_NAME.lower() (если заполнено)
   │
   ├─ ТОЧНОЕ совпадение найдено?
   │  └─ Вернуть контакт → Использовать его ID
   │
   └─ ТОЧНОГО совпадения нет?
      └─ Вернуть None → Создать новый контакт
```

**2.2. Проверка на семью**

**Метод:** `Bitrix24APIClient.find_all_contacts_by_phone()`
**Файл:** `src/bitrix/api_client.py:368`

```python
1. API запрос: crm.contact.list
   - Фильтр: PHONE = "+79991234567"
   - Возвращает ВСЕ контакты с этим телефоном

2. Анализ количества:
   ├─ 0 контактов
   │  └─ Лог: "Создаем первый контакт для телефона +7999..."
   │  └─ Создать новый контакт
   │
   └─ ≥1 контакт (но без точного совпадения ФИО)
      └─ Лог: "Найдено N контактов с телефоном... Создаем новый контакт (член семьи)"
      └─ Создать новый контакт
```

**Пример:**
```
Телефон: +79991234567

Контакт 1: Иванов Иван Иванович
Контакт 2: Иванова Мария Ивановна  ← Жена
Контакт 3: Иванов Петр Иванович     ← Сын

Все 3 контакта с одним телефоном, но разные люди!
```

**2.3. Создание контакта**

**Метод:** `Bitrix24APIClient.create_contact()`
**Файл:** `src/bitrix/api_client.py:411`

```python
API запрос: crm.contact.add
Поля:
  - NAME: Имя
  - LAST_NAME: Фамилия
  - SECOND_NAME: Отчество
  - PHONE: [{"VALUE": "+79991234567", "VALUE_TYPE": "WORK"}]
  - ASSIGNED_BY_ID: ID ответственного (из конфига)
  - UF_CRM_1769072843903: Источник "IDENT"
```

---

### ШАГ 3: Автопривязка сделок без IDENT ID

**Метод:** `Bitrix24APIClient.find_deals_by_contact_without_ident_id()`
**Файл:** `src/bitrix/api_client.py:597`

**Цель:** Найти сделки, которые менеджер создал вручную (до того как появилась запись в IDENT)

**Действия:**
```python
1. API запрос: crm.deal.list
   - Фильтр:
     - CONTACT_ID = contact_id
     - UF_CRM_1769072841035 = False (поле IDENT ID пустое)
   - Сортировка: DATE_CREATE DESC (сначала новые)
   - Поля: ID, STAGE_ID, DATE_CREATE, TITLE, UF_CRM_1769072841035

2. Фильтрация финальных стадий:
   ├─ exclude_final = True (по умолчанию)
   │  └─ Убрать сделки в стадиях WON, LOSE
   └─ exclude_final = False
      └─ Вернуть все сделки

3. Возврат:
   └─ Список сделок, отсортированный по DATE_CREATE DESC
```

**Обработка результата:**
```python
Найдено 0 сделок:
  └─ Перейти к шагу 4 (создание новой сделки)

Найдена 1 сделка:
  ├─ Лог: "АВТОПРИВЯЗКА: Сделка {id} привязана к {ident_id}"
  └─ Обновить сделку: добавить IDENT ID + все данные из записи

Найдено >1 сделки:
  ├─ Лог WARNING: "МНОЖЕСТВЕННЫЕ СДЕЛКИ: Найдено N сделок..."
  ├─ Привязать к самой СВЕЖЕЙ (первая в списке)
  └─ Остальные логировать для ручной проверки
```

**Пример лога:**
```
МНОЖЕСТВЕННЫЕ СДЕЛКИ: Найдено 3 открытых сделок без IDENT ID для контакта 567.
Привязываем к самой свежей: 12345.
Остальные: [12344, 12343]
```

**Автопривязка:**
```python
# Обновление сделки
API запрос: crm.deal.update
Поля:
  - UF_CRM_1769072841035: "F1_12345"  ← Добавляем IDENT ID
  - STAGE_ID: "C1:CONSULTATION_DONE"
  - ... все остальные поля из записи IDENT
```

---

### ШАГ 4: Создание новой сделки

**Метод:** `Bitrix24APIClient.create_deal()`
**Файл:** `src/bitrix/api_client.py:481`

**Выполняется только если:**
- Сделка с IDENT ID не найдена (или закрыта)
- Контакт найден/создан
- Сделок без IDENT ID у контакта НЕТ

**Действия:**
```python
API запрос: crm.deal.add
Поля:
  - TITLE: "Millident - Иванов Иван Иванович"
  - CONTACT_ID: 567
  - STAGE_ID: "C1:CONSULTATION_SCHEDULED"
  - ASSIGNED_BY_ID: ID ответственного
  - UF_CRM_1769072841035: "F1_12345" (IDENT ID)
  - UF_CRM_1769083581481: "C12345" (номер карты)
  - ... другие поля
```

**Пример лога:**
```
Создаем новую сделку для контакта 567
Создана сделка 12345 для F1_67890
```

---

## Сценарии использования

### Сценарий 1: Первая запись нового пациента

**Исходные данные:**
- IDENT ID: `F1_12345`
- ФИО: Иванов Иван Иванович
- Телефон: +79991234567
- Стадия: Консультация назначена

**Выполнение:**
```
Шаг 1: Поиск сделки F1_12345 → НЕ НАЙДЕНА
Шаг 2: Поиск контакта +7999... "Иванов Иван Иванович" → НЕ НАЙДЕН
        └─ Создан контакт ID: 567
Шаг 3: Поиск сделок без IDENT для контакта 567 → НЕ НАЙДЕНО
Шаг 4: Создана сделка ID: 12345 с IDENT ID: F1_12345
```

**Результат в Bitrix24:**
- ✅ Контакт #567: Иванов Иван Иванович
- ✅ Сделка #12345: "Millident - Иванов Иван Иванович" (F1_12345)

---

### Сценарий 2: Обновление существующей записи

**Исходные данные:**
- IDENT ID: `F1_12345` (уже есть в Bitrix24)
- Стадия изменилась: Консультация назначена → Консультация проведена

**Выполнение:**
```
Шаг 1: Поиск сделки F1_12345 → НАЙДЕНА (ID: 12345, стадия: открытая)
        └─ Обновление: стадия → "Консультация проведена"
        └─ ЗАВЕРШЕНИЕ (шаги 2-4 не выполняются)
```

**Результат:**
- ✅ Сделка #12345 обновлена (новая стадия)

---

### Сценарий 3: Менеджер создал сделку вручную

**Последовательность событий:**
1. Пациент позвонил → Менеджер создал контакт "Петров П.П." + сделку в Bitrix24
2. Менеджер создал запись в IDENT
3. Интеграция синхронизирует IDENT → Bitrix24

**Исходные данные в Bitrix24 ДО синхронизации:**
- Контакт #890: Петров Петр Петрович, +79991111111
- Сделка #22222: без IDENT ID, контакт #890

**Данные из IDENT:**
- IDENT ID: `F1_99999`
- ФИО: Петров Петр Петрович
- Телефон: +79991111111

**Выполнение:**
```
Шаг 1: Поиск сделки F1_99999 → НЕ НАЙДЕНА
Шаг 2: Поиск контакта +7999... "Петров Петр Петрович" → НАЙДЕН (ID: 890)
Шаг 3: Поиск сделок без IDENT для контакта 890 → НАЙДЕНА 1 сделка (ID: 22222)
        └─ АВТОПРИВЯЗКА: добавляем IDENT ID "F1_99999" к сделке 22222
        └─ Обновляем все поля сделки данными из IDENT
        └─ ЗАВЕРШЕНИЕ (шаг 4 не выполняется)
```

**Результат:**
- ✅ Сделка #22222 обновлена (добавлен IDENT ID + данные из записи)
- ✅ Дубликат НЕ создан!

---

### Сценарий 4: Семья с одним телефоном

**Исходные данные в Bitrix24:**
- Контакт #100: Иванов Иван Иванович, +79991234567
- Контакт #101: Иванова Мария Ивановна, +79991234567 (жена)

**Данные из IDENT (новая запись сына):**
- IDENT ID: `F1_88888`
- ФИО: Иванов Петр Иванович
- Телефон: +79991234567 (семейный)

**Выполнение:**
```
Шаг 1: Поиск сделки F1_88888 → НЕ НАЙДЕНА
Шаг 2: Поиск контакта +7999... "Иванов Петр Иванович" → НЕ НАЙДЕН
        ├─ Найдено 2 контакта с этим телефоном (Иван, Мария)
        └─ Лог: "Найдено 2 контактов с телефоном +7999... Создаем новый контакт (член семьи)"
        └─ Создан контакт ID: 102 (Иванов Петр Иванович)
Шаг 3: Поиск сделок без IDENT для контакта 102 → НЕ НАЙДЕНО
Шаг 4: Создана сделка ID: 33333 для контакта 102
```

**Результат:**
- ✅ Контакт #100: Иванов Иван Иванович, +79991234567
- ✅ Контакт #101: Иванова Мария Ивановна, +79991234567
- ✅ Контакт #102: Иванов Петр Иванович, +79991234567 ← НОВЫЙ
- ✅ Сделка #33333 для контакта #102

---

### Сценарий 5: Закрытая сделка (повторное обращение)

**Исходные данные в Bitrix24:**
- Сделка #12345: IDENT ID = F1_12345, стадия = WON (Успешно)

**Данные из IDENT (новая запись с тем же пациентом):**
- IDENT ID: `F1_12345` (тот же!)
- ФИО: Иванов Иван Иванович
- Телефон: +79991234567
- Стадия: Консультация назначена

**Выполнение:**
```
Шаг 1: Поиск сделки F1_12345 → НАЙДЕНА (ID: 12345, стадия: WON - финальная!)
        └─ Лог: "IGNORE: Сделка 12345 с IDENT ID F1_12345 уже закрыта (стадия 'C1:WON')"
        └─ Игнорируем эту сделку → Перейти к шагу 2
Шаг 2: Поиск контакта → НАЙДЕН (ID: 567)
Шаг 3: Поиск сделок без IDENT для контакта 567 → НЕ НАЙДЕНО
Шаг 4: Создана НОВАЯ сделка ID: 12346 с IDENT ID: F1_12345
```

**Результат:**
- ✅ Старая сделка #12345 (F1_12345, WON) - БЕЗ ИЗМЕНЕНИЙ
- ✅ Новая сделка #12346 (F1_12345, CONSULTATION_SCHEDULED) - СОЗДАНА
- ⚠️ Два сделки с одинаковым IDENT ID (одна закрыта, одна открыта)

---

### Сценарий 6: Защищенные стадии

**Исходные данные в Bitrix24:**
- Сделка #12345: IDENT ID = F1_12345, стадия = TREATMENT (Лечение)

**Данные из IDENT:**
- IDENT ID: `F1_12345`
- Стадия: PREPAYMENT_RECEIVED (в IDENT стадия сменилась назад)

**Защищенные стадии:**
- `PREPAYMENT_RECEIVED` - Предоплата получена
- `TREATMENT` - Лечение

**Выполнение:**
```
Шаг 1: Поиск сделки F1_12345 → НАЙДЕНА (ID: 12345, стадия: TREATMENT)
        └─ Стадия защищенная!
        └─ Лог: "PROTECTED: Сделка 12345 в защищенной стадии 'C1:TREATMENT'"
        └─ Обновление БЕЗ изменения stage_id
        └─ Обновляем: телефон, номер карты, комментарии и т.д.
        └─ НЕ обновляем: stage_id остается TREATMENT
```

**Результат:**
- ✅ Сделка #12345 обновлена (все поля кроме stage_id)
- ✅ Стадия осталась TREATMENT (не изменилась на PREPAYMENT_RECEIVED)

---

## Особые случаи

### Множественные сделки без IDENT ID

**Ситуация:**
- Контакт #567
- Сделка #100 (без IDENT ID, дата создания: 2025-01-15)
- Сделка #101 (без IDENT ID, дата создания: 2025-01-20) ← новее
- Сделка #102 (без IDENT ID, дата создания: 2025-01-10)

**Обработка:**
```
Шаг 3: Найдено 3 сделки без IDENT ID
       ├─ Сортировка по DATE_CREATE DESC: [101, 100, 102]
       ├─ WARNING: "МНОЖЕСТВЕННЫЕ СДЕЛКИ: Найдено 3 открытых сделок..."
       └─ Автопривязка к самой свежей: сделка #101
```

**Лог:**
```
МНОЖЕСТВЕННЫЕ СДЕЛКИ: Найдено 3 открытых сделок без IDENT ID для контакта 567.
Привязываем к самой свежей: 101.
Остальные: [100, 102]
```

**Действия администратора:**
- Проверить лог
- Вручную привязать остальные сделки (100, 102) к другим записям IDENT
- Или закрыть лишние сделки

---

### Отсутствие номера карты

**Ситуация:**
- В IDENT нет поля `card_number` для записи

**Обработка:**
```python
if card_number and deal_id:
    # Синхронизировать план лечения
    sync_plan_for_deal(deal_id, card_number)
elif deal_id and not card_number:
    # Логировать предупреждение
    logger.debug("WARNING: CardNumber отсутствует для сделки {deal_id}")
```

**Результат:**
- ⚠️ Сделка создана/обновлена
- ⚠️ План лечения НЕ синхронизирован
- ⚠️ В логах есть предупреждение

---

### Пустое ФИО в контакте

**Ситуация:**
- `name = ""` или `last_name = ""`

**Обработка:**
```python
# В методе find_contact_by_phone_and_name()
if not name or not last_name:
    return None  # Не искать, сразу создать новый контакт
```

**Результат:**
- Всегда создается новый контакт (без поиска)
- Может привести к дубликатам

---

### Финальные стадии

**Определение:**
```python
FINAL_STAGES = ['C1:WON', 'C1:LOSE']
```

**Поведение:**
- Сделки в этих стадиях **НЕ обновляются**
- Сделки в этих стадиях **игнорируются** при автопривязке
- При повторной синхронизации создается **новая сделка**

---

### Защищенные стадии

**Определение:**
```python
PROTECTED_STAGES = ['C1:PREPAYMENT_RECEIVED', 'C1:TREATMENT']
```

**Поведение:**
- Обновляются **все поля кроме** `stage_id`
- Защита от случайного "отката" стадии назад
- Логируется: `PROTECTED: Сделка {id} в защищенной стадии...`

---

## Блок-схема полного процесса

```
┌─────────────────────────────────────────────────────────────────┐
│ Запись из IDENT: F1_12345, Иванов И.И., +7999...               │
└────────────────────────────┬────────────────────────────────────┘
                             ↓
              ┌──────────────────────────────┐
              │ ШАГ 1: Поиск по IDENT ID     │
              └──────────┬───────────────────┘
                         ↓
            ┌────────────┴────────────┐
            │ Сделка найдена?         │
            └────┬─────────────────┬──┘
                 ↓ ДА              ↓ НЕТ
         ┌───────────────┐         │
         │ Стадия?       │         │
         └──┬──────────┬─┘         │
            ↓          ↓           │
        Финальная  Открытая        │
        (WON/LOSE) (другие)        │
            ↓          ↓           │
        Игнорировать  Обновить     │
            ↓          ↓           │
            └──────┬───┘           │
                   ↓               ↓
              ┌────────────────────────────────┐
              │ ШАГ 2: Поиск/создание контакта │
              └─────────────┬──────────────────┘
                            ↓
              ┌─────────────────────────────────┐
              │ Поиск по телефону + ФИО         │
              └─────┬───────────────────────────┘
                    ↓
          ┌─────────┴──────────┐
          │ Найден?            │
          └───┬────────────┬───┘
              ↓ ДА         ↓ НЕТ
          Использовать  Создать новый
          существующий     ↓
              ↓         (проверка на семью)
              └────┬──────┘
                   ↓
        ┌──────────────────────────────────┐
        │ ШАГ 3: Поиск сделок без IDENT ID │
        └──────────┬───────────────────────┘
                   ↓
         ┌─────────┴─────────┐
         │ Найдено сделок?   │
         └─┬──────┬────────┬─┘
           ↓ 0    ↓ 1      ↓ >1
           │   Автопривязка  Автопривязка к новейшей
           │      ↓          + WARNING в лог
           │      └────┬─────┘
           ↓           ↓
    ┌──────────────────────────┐
    │ ШАГ 4: Создать сделку    │
    └──────────────────────────┘
```

---

## Настройки конфигурации

**Файл:** `config.ini`

### Связанные параметры:

```ini
[Bitrix24]
# ID пользователя по умолчанию для ответственного в контактах/сделках
default_assigned_by_id = 13

[Sync]
# Включить обновление существующих сделок (если False - только стадия)
enable_update_existing = True
```

### Поля в Bitrix24:

| Поле                    | ID                     | Назначение                |
|-------------------------|------------------------|---------------------------|
| IDENT ID                | UF_CRM_1769072841035   | Уникальный ID записи      |
| Номер карты             | UF_CRM_1769083581481   | Номер карты пациента      |
| Источник                | UF_CRM_1769072843903   | "IDENT"                   |

---

## Резюме

**Основные принципы:**
1. Поиск всегда начинается с IDENT ID
2. Закрытые сделки не переоткрываются (создается новая)
3. Контакты ищутся по телефону + ТОЧНОЕ совпадение ФИО
4. Семьи (один телефон, разные люди) создают отдельные контакты
5. Автопривязка помогает избежать дубликатов
6. Защищенные стадии не изменяются автоматически

**Что делать при проблемах:**
- Проверить логи (logs/integration_log_*.txt)
- Искать ключевые слова: IGNORE, АВТОПРИВЯЗКА, МНОЖЕСТВЕННЫЕ СДЕЛКИ, PROTECTED
- Проверить очередь (data/queue.db)
