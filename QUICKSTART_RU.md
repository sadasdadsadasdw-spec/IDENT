# –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Ident ‚Üí Bitrix24

## ‚úÖ –ß—Ç–æ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
- Python 3.10+
- ODBC Driver 17 for SQL Server

## üìã –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements.txt
```

## üìù –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
```bash
copy config.example.ini config.ini
```

2. –û—Ç–∫—Ä–æ–π—Ç–µ `config.ini` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ:

### [Database]
```ini
server = –í–ê–®_SQL_SERVER
port = 1433
database = IdentDB
username = –í–ê–®_–õ–û–ì–ò–ù
password = –í–ê–®_–ü–ê–†–û–õ–¨_–ù–ï–ó–ê–®–ò–§–†–û–í–ê–ù–ù–´–ô
```

### [Bitrix24]
```ini
webhook_url = https://–≤–∞—à-–¥–æ–º–µ–Ω.bitrix24.ru/rest/1/–í–ê–®_–¢–û–ö–ï–ù
token = –í–ê–®_–¢–û–ö–ï–ù
```

### [Sync]
```ini
filial_id = 1
interval_minutes = 2
batch_size = 50
initial_days = 7
```

## üîê –®–∞–≥ 3: –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è config.ini –∑–∞—à–∏—Ñ—Ä—É–π—Ç–µ –ø–∞—Ä–æ–ª–∏:

```bash
python src/config/config_manager_v2.py --config config.ini --encrypt
```

–≠—Ç–æ –∑–∞—à–∏—Ñ—Ä—É–µ—Ç:
- Database.password
- Bitrix24.token
- Notifications.smtp_password (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

‚ö†Ô∏è **–í–ê–ñ–ù–û**: –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –≤–∞—à–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é Windows!

## üß™ –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

```bash
python main.py
```

–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –ó–∞–≥—Ä—É–∑–∏—Ç –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î Ident
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Bitrix24 API
4. –ù–∞—á–Ω–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é

## üìä –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –õ–æ–≥–∏
–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–∞–ø–∫–µ `logs/`:
```
logs/integration_log_2026-01-21.txt
```

### –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
–í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤:
```
sync_state.json
```

### –û—á–µ—Ä–µ–¥—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
–ù–µ—É–¥–∞—á–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤:
```
queue.json
```

## üéØ –ß—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è

### –ò–∑ Ident ‚Üí Bitrix24:
- **–ü–∞—Ü–∏–µ–Ω—Ç** ‚Üí –ö–æ–Ω—Ç–∞–∫—Ç (–∏–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –õ–∏–¥–∞)
- **–ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏–µ–º** ‚Üí –°–¥–µ–ª–∫–∞

### –ü–æ–ª—è —Å–¥–µ–ª–∫–∏:
- **UF_CRM_1769008900** - –î–∞—Ç–∞ –Ω–∞—á–∞–ª–æ –ø—Ä–∏–µ–º–∞
- **UF_CRM_1769008947** - –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–∏–µ–º–∞
- **UF_CRM_1769008996** - –í—Ä–∞—á
- **UF_CRM_1769009098** - –£—Å–ª—É–≥–∏

### –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞–¥–∏–π:
| –°—Ç–∞—Ç—É—Å Ident | –°—Ç–∞–¥–∏—è Bitrix24 |
|--------------|----------------|
| –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω | NEW (–ó–∞–ø–∏—Å—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é) |
| –ü–∞—Ü–∏–µ–Ω—Ç –ø—Ä–∏—à–µ–ª | NEW |
| –í –ø—Ä–æ—Ü–µ—Å—Å–µ | PREPARATION (–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∞) |
| –ó–∞–≤–µ—Ä—à–µ–Ω | UC_NO40X0 (–õ–µ—á–µ–Ω–∏–µ) |
| –ó–∞–≤–µ—Ä—à–µ–Ω (—Å—á–µ—Ç –≤—ã–¥–∞–Ω) | WON (–°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–∞) |
| –û—Ç–º–µ–Ω–µ–Ω | LOSE (–°–¥–µ–ª–∫–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞) |

### –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ —Å—Ç–∞–¥–∏–∏ (–Ω–µ –º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):
- PREPAYMENT_INVOICE (–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –ø–ª–∞–Ω–∞ –ª–µ—á–µ–Ω–∏—è)
- FINAL_INVOICE (–ü–æ–ª—É—á–µ–Ω–∞ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞)
- EXECUTING (–õ–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è)
- APOLOGY (–ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–≤–∞–ª–∞)

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### config.ini - [Sync]
```ini
interval_minutes = 2      # –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–º–∏–Ω)
batch_size = 50          # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –∑–∞ —Ä–∞–∑ (1-1000)
initial_days = 7         # –ì–ª—É–±–∏–Ω–∞ –ø–µ—Ä–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–¥–Ω–∏)
```

### config.ini - [Database]
```ini
connection_timeout = 10  # –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (—Å–µ–∫)
query_timeout = 30       # –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (—Å–µ–∫)
```

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –í —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (–∫–æ–Ω—Å–æ–ª—å):
```
================================================================================
–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
================================================================================
–ü–æ–ª—É—á–µ–Ω–æ –∏–∑ –ë–î:       50
–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ:     50
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:     48
–û—à–∏–±–æ–∫:               2
–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:     3.45—Å
================================================================================
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏:
```
–û—á–µ—Ä–µ–¥—å: –≤—Å–µ–≥–æ=2, pending=0, failed=2, completed=0
```

## üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞

–ù–∞–∂–º–∏—Ç–µ **Ctrl+C** –¥–ª—è graceful shutdown:
- –ó–∞–≤–µ—Ä—à–∏—Ç —Ç–µ–∫—É—â—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
- –°–æ—Ö—Ä–∞–Ω–∏—Ç last_sync_time
- –ó–∞–∫—Ä–æ–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î

## ‚ùå –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –û—à–∏–±–∫–∞ "–ù–µ –Ω–∞–π–¥–µ–Ω ODBC –¥—Ä–∞–π–≤–µ—Ä"
**–†–µ—à–µ–Ω–∏–µ**: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ODBC Driver 17 for SQL Server
```
https://learn.microsoft.com/sql/connect/odbc/download-odbc-driver-for-sql-server
```

### 2. –û—à–∏–±–∫–∞ "DPAPI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
**–†–µ—à–µ–Ω–∏–µ**: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pywin32
```bash
pip install pywin32
```

### 3. –û—à–∏–±–∫–∞ "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω–∞"
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ config.ini

### 4. –û—à–∏–±–∫–∞ "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î"
**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ server, port, database
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ SQL Server –¥–æ—Å—Ç—É–ø–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å

### 5. –û—à–∏–±–∫–∞ "401/403 –æ—Ç Bitrix24"
**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook_url
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ webhook –∞–∫—Ç–∏–≤–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ webhook

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- 50 –∑–∞–ø–∏—Å–µ–π = 5-10 —Å–µ–∫—É–Ω–¥
- N+1 –ø—Ä–æ–±–ª–µ–º–∞ (100+ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î)
- 1500 –Ω–æ–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ —á–∞—Å

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- 50 –∑–∞–ø–∏—Å–µ–π = 0.5-1 —Å–µ–∫—É–Ω–¥–∞ ‚ö° **10-20x –±—ã—Å—Ç—Ä–µ–µ**
- 1 –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å (OUTER APPLY)
- 3 –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ —Å–±–æ—è—Ö

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚úÖ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π —á–µ—Ä–µ–∑ Windows DPAPI
‚úÖ –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –ü–î –≤ –ª–æ–≥–∞—Ö (—Ç–µ–ª–µ—Ñ–æ–Ω—ã, email, –§–ò–û)
‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ config.ini

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –≤ `logs/integration_log_YYYY-MM-DD.txt`
